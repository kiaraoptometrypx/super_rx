

<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Hypervision-Rx</title>
<style>
html, body, table, th, td, input, button, select, option, a, b, label {
  font-size: 11px !important;
  font-family: 'Manrope', sans-serif;
  box-sizing: border-box;
  margin: 0;
  padding: 0;
}

th.red, td.red {
  background: #E0E0E0;
  color: black;
}

th.yellow, td.yellow, button.yellow {
  background: #EBDADA;
  color: black;
}
th.blue, td.blue, button.blue{
  background: #D8E7F0;
  color: black;
}

/* Column 1: width 25% */
td:nth-child(1),
th:nth-child(1) {
  width: 22%;
}

/* Column 2: width 25% + remove RIGHT border */
td:nth-child(2),
th:nth-child(2) {
  width: 26%;
}
button.{user-select:none;}

button.greyonclick.clicked {
  background: #444 !important;
  color: #fff !important;
  border-color: #666 !important;
  cursor: default;
  user-select:none;
}

/* Column 3: width 25% + remove LEFT & RIGHT borders */
td:nth-child(3),
th:nth-child(3) {
  width: 26%;
}

/* Column 4: width 25% + remove LEFT border */
td:nth-child(4),
th:nth-child(4) {
  width: 26%;
}


.hidden-row {
  opacity: 0.0;       /* semi-transparent */
  pointer-events: none; /* optional: disable interactions */
}

  body {
    font-family: 'Manrope', sans-serif;
    background: #f5f5f5;
    display: flex;
    flex-direction: column;
    align-items: center;
  }


  table {
    border-collapse: collapse;
    width: 100%;
    max-width: 600px;
    min-width: 600px;
    margin-top: 20px;
    text-align: center;
  }

  th {
    border-bottom: 1px solid #aaa;
    border-top: 1px solid #aaa;
    padding: 10px 15px;
    text-align: center;
  }
  td {
    border-bottom: 1px solid #aaa;
    border-top: 1px solid #aaa;
    background: #f5f5f5;

    padding: 10px;
    text-align: center;
  }

  th {
    background: #eee;
    font-weight: 600;
  }

  input {
    width: 80px;
    text-align: center;
    padding: 4px 6px;
    border: 1px solid lightgrey;
    border-radius:6px;
  }

.rx-strike {
  text-decoration: line-through;
  opacity: 0.5;
}


button {
border: 1px dotted;
}

body, table, th, td, input, button {
  font-size: 11px;
}

/* Layout */
.layout {
  display: flex;
  align-items: flex-start;
}

/* Sidebar */
.sidebar {
  position: sticky;
  top: 40px;
  width: 150px;
  height: 98vh;
  color: #6f2218;
  padding: 15px;
  box-sizing: border-box;
  flex-shrink: 0;
}

.sidebar h3 {
  margin: 0 0 24px;
  font-size: 18px;
  letter-spacing: 1px;
}

.sidebar a {
  display: block;
  font-size: 20px;
  font-weight: 600;
  color: #6f2218;
  text-decoration: none;
  margin-bottom: 80px;
  margin-top: 80px;
  cursor: pointer;
}

.sidebar a:hover {
  text-decoration: underline;
}

/* Content (no transition) */
.content {
  flex: 1;
  padding: 0px 30px 0px 30px;
  opacity: 1;
}


/* Sections */
.section {
  max-height: 900px;
  margin-bottom: 750px;
  margin-top: 70px;
}

.updateAllBtn {
  cursor: pointer;
}

.updateAllBtn.updated {
  background: #444;
  color: #fff;
}

#topBlock {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 50px; /* use fixed px for consistency */
  background: #6f2218;
  color: white;
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 0 3%;
  box-sizing: border-box;
  z-index: 9999;
}

#topBlock h2 {
  font-size: 17px;
  margin-left:3%;
  margin-right:10%; /* remove extra margin */
}

.topMenu a {
  color: white;
  text-decoration: none;
  margin-left: 20px; /* fixed spacing instead of percentage */
  font-weight: 600;
  font-size: 14px; /* slightly bigger for readability */
  cursor: pointer;
}

.topMenu a:hover {
  text-decoration: underline;
}


  .card{ background:#fff; border-radius:10px; padding:20px 10px;
    box-shadow:0 0 10px rgba(0,0,0,.25); display:inline-block; border:1px solid #bbb; margin:8px 0 14px; }
  .row input[type=number]{ width:70px; text-align:center; }
  .row b{ display:inline-block; margin-bottom:6px; }
  button{ margin:0px; padding:5px 10px; cursor:pointer; border-radius:6px }
/* Duochrome */
.duochrome {
  display: flex;
  justify-content: center;
  align-items: center;
  width: 255px;      /* 85% of 300px */
  height: 255px;     /* 85% of 300px */
  margin: 17px auto; /* 85% of 20px */
  position: relative;
  overflow: hidden;
}
.duo-side {
  position: relative;
  width: 128px;      /* 85% of 150px */
  height: 255px;     /* 85% of 300px */
  display: flex;
  align-items: center;
  justify-content: center;
  overflow: clip;
  contain: paint;
  isolation: isolate;
}
@supports not (overflow: clip) { 
  .duo-side { overflow: hidden; } 
}
#redSide  { clip-path: inset(0 0 0 9px); }   /* 85% of 10px */
#blueSide { clip-path: inset(0 9px 0 0); }   /* 85% of 10px */
.duo-side img.base {
  width: 128px;      /* 85% of 150px */
  height: 255px;     /* 85% of 300px */
  object-fit: cover;
  display: block;
  will-change: filter;
}
.duo-side img.overlay {
  display: block;
  position: absolute;
  left: 0;
  top: 0;
  width: 128px;      /* 85% of 150px */
  height: 255px;     /* 85% of 300px */
  object-fit: cover;
  pointer-events: none;
  will-change: transform, filter, opacity;
  backface-visibility: hidden;
  transform: translate3d(0,0,0);
}

/* Fan chart */
.outer-circle {
  width: 213px;      /* 85% of 250px */
  height: 213px;     /* 85% of 250px */
  border-radius: 50%;
  border: none;
  overflow: hidden;
  display: flex;
  align-items: center;
  justify-content: center;
  margin: 34px auto; /* 85% of 40px */
  transform-origin: center;
}
.circular-img img {
  width: 255px;      /* 85% of 300px */
  height: auto;
  object-fit: cover;
  object-position: center;
  transform-origin: center;
}

/* Fan chart */
.outer-circle {
  width: 175px;    /* 70% of 250px */
  height: 175px;   /* 70% of 250px */
  border-radius: 50%;
  border: none;
  overflow: hidden;
  display: flex;
  align-items: center;
  justify-content: center;
  margin: 28px auto;  /* 70% of 40px */
  transform-origin: center;
}
.circular-img img {
  width: 210px;    /* 70% of 300px */
  height: auto;
  object-fit: cover;
  object-position: center;
  transform-origin: center;
}

  /* Layout */
  #stage { display:flex; gap:10px; align-items:center; justify-content:center; flex-wrap:wrap; }
  .duochrome, .outer-circle { margin:12px 0; }

  .rx-input { width:100px; font-size:10px; text-align:center; padding:6px; border-radius:6px; border:1px solid #ccc; margin-bottom:5px; }
  .btn-plus, .btn-minus { font-size:10px; border:1px dotted ; height:30px; width:50px; border-radius:6px; cursor:pointer; color:black; transition:opacity .2s; margin:5px; }
  .btn-plus { background:#E0E0E0; } .btn-minus{ background:#d9534f; }
  .btn-plus:hover, .btn-minus:hover { opacity:.85; }
  .btn-group button { font-size:10px; padding:5px 5px; margin:5px; border:1px solid #000; border-radius:10px; cursor:pointer; background:#dcdcdc; color:#000; min-width:160px; }
  .btn-group button:hover { background:#c8c8c8; }

  #targetPanel input{ width:60px; font-size:10px; padding:5px; text-align:center; margin:2px 2px; border-radius:5px; }

/* General dropdown styling */
select {
  padding: 5px 10px;
  font-size: 12px;
  border: 1px dotted black;
  border-radius: 6px;
  background-color: #fff;
  color: black;
  transition: 0.1s;
}

/* Hover effect */
select:hover {
  border-color: #E0E0E0;
  background-color: #E0E0E0;
}

/* Focus effect */
select:focus {
  border-color: #E0E0E0;
  background-color: #fff;
}

/* Option styling (limited support in browsers) */
option {
  padding: 8px;
  font-size: 12px;
}
.resultRow {
  margin-bottom: 10px;
}

</style>

</head>
<body>


<div id="topBlock">
<h2> Ready?</h2>
  <nav class="topMenu" style="user-select:none">
      <a data-target="s-1">Intro</a>
    <a data-target="s0">Current Rx</a>
    <a data-target="s2">Vector RX</a>
    <a data-target="s3">Manual RX</a>
    <a data-target="s4">Summary</a>
    <a data-target="s1">Analysis</a>
    <a data-target="s6">How Eyes Work</a>
    <a data-target="s5">Lenses</a>

  </nav>
</div>
<div style="height:70px"></div>

<div>
<button type="button" onclick="screener()">Toggle Screener</button> 
<button id="copyBtn"  onclick="copyText()">Copy</button>

</div>


<script>
function screener() {
  const el = document.getElementById("screenerPanel");
  el.style.display = (el.style.display === "none" || el.style.display === "")
    ? "block"
    : "none";
}

function copyText() {
  const text = document.getElementById("screenerText").innerText;
  navigator.clipboard.writeText(text);
  document.getElementById("copyBtn").innerText = "Copied";
}
</script>

<div class="layout">
  <main id="content" class="content">


<div id="screenerPanel" style="display:none;">
<table>
  <tr>
    <td id="screenerText" style="text-align:left; line-height:1.6;">
      1. Calculate: +0.25 + (-0.75)<br>
      2. Calculate: -1.25 + 0.50<br>
      3. Calculate: +2.00 − 0.75<br>
      4. Calculate: -0.50 − 0.25<br>
      5. Calculate: +1.75 + (-2.25)<br>
      6. Calculate: Start at -1.00. Add +0.25 three times.<br>
      7. Calculate: Start at +0.50. Subtract +0.25, then subtract +0.50.<br>
      8. Calculate: Start at +0.75. Increase by -0.25 four times.<br>
      9. Which is bigger: -0.25 or -0.75?<br>
      10. Which is lower: +0.50 or -0.75?<br>
      11. Which is closer to zero: +0.50 or -0.25?<br>
      12. Complete the sequence: -1.00, -0.75, -0.50, ?<br>
      13. Complete the sequence: +0.25, +0.50, ?, +1.00<br>
      14. Calculate: Start at -0.50, increase by +0.25, then decrease by -0.75.<br>
      15. If blue is add, red is subtract, what do you do when +1.00 is red? +1.25 or +0.75?<br>
      16. If blue is add, red is subtract, what do you get when +1.00 is blue 3 times? +0.25 or +1.75?<br>
      17. Using a logic of a clock, 3 o'clock and 9 o'clock is the same axis, right or wrong?<br>
      18. Using a logic of a clock, 3 o'clock and 12 o'clock is the same axis, right or wrong?<br>
      19. Using a logic of a clock, what is the perpendicular value of 10:30 o'clock?<br>
      20. The middle between +0.25 and +0.75 is +0.50. What is the middle between -1.00 and -2.00?<br>
      21. The middle between +0.25 and +0.75 is +0.50. What is the middle between +0.50 and -1.00?<br>
      22. What is -1.50 divided by 2, then added to -4.00?<br>
      23. Using a logic of a clock, if -1.00 is 3 o'clock, -1.50 is 12 o'clock, what is -1.25?<br>
    </td>
  </tr>
</table>

</div>



    <div id="s-1" class="section">
<div style="height:70px"></div>
<table>
<tr><th class="red" colspan="4">Intro</th></tr>
<tr>
  <td colspan="4" style="height:400px; text-align:center; padding:20px; vertical-align:middle; background-color:#EBDADA;">

    <h1 style="margin:0 10% 0 10%; color:#6F2218; line-height:25px; text-align:left;">HYPERVISION Eye Exam<br>---</h1>

    <p style="margin:0 10% 3% 10%; font-size:15px; line-height:20px; text-align:left;">The best prescription are smooth, comfortable and clear.<br>And this test always deliver.</p>

    <p style="margin:0% 10% 3% 10%; font-size:12px; line-height:15px; text-align:left;">Mathematically converts blur & discomfort into data.<br>Then the best prescriptions are formula generated.</p>

    <p style="margin:0% 10% 0% 10%; font-size:12px; color:#6F2218; line-height:18px; text-align:left;">This test helps those who:</p>

<ul style="margin:0% 10%; font-size:12px; color:#6F2218; padding-left:20px; text-align:left;">
  <li>Are age 35 and above.
  <li>Are dizzy when changing glasses.</li>
  <li>Have unexplained headaches and bluriness.</li>
  <li>Have weaker vision than your peers.</li>
  <li>Wants to see their very best possible.</li>

  <li>Appreciates how science creates your best vision.</li>

</ul>
    </p>
  </td>
</tr>

<tr style="border:none; height:10px;">
  <td style="border:none; height:1px; padding:0;"></td>
  <td style="border:none; height:1px; padding:0;"></td>
  <td style="border:none; height:1px; padding:0;"></td>
  <td style="border:none; height:1px; padding:0;"></td>
</tr>

<tr>
<td colspan="2" style="border-right:none;">
  Name :
  <input type="text" id="customerName"
         placeholder="First Name Last Name"
         style="width:65%; height:20px"
         oninput="updateCustomerName()">
</td>



<td colspan="2" style="border-left:none;" >Whatsapp : <input type="text" id="customerWhatsapp" style="width:65%; height:20px"placeholder="6012 3456 789"></td>

</tr>
<tr>

<td colspan="3" style="border-right:none; vertical-align:middle;">
  Message :
  <input type="text" id="notes" style="width:74%; border-radius:5px; border:1px solid lightgrey; height:25px; vertical-align:middle;" placeholder="Notes To Whatsapp"></textarea>
</td>


<td style="border-left:none" colspan="1">
<button style="border-radius:10px; height:25px; width:100px" id="sendWhatsappBtn">Send WA</button>

</td> </tr>












</table>

</div>
 
    <div id="s0" class="section">
<div style="height:70px"></div>
<table>

<tr><th class="red" colspan="4">Current RX</th></tr>



<tr style="border:none; height:10px;">
  <td style="border:none; height:1px; padding:0;"></td>
  <td style="border:none; height:1px; padding:0;"></td>
  <td style="border:none; height:1px; padding:0;"></td>
  <td style="border:none; height:1px; padding:0;"></td>
</tr>


<tr><th class="red" colspan="4"><i>Load a file by copying everything and pasting in any input, press this button to use latest RX. </i><br>

<button style="margin-top:5px; margin-right:15px; background-color:white; border-radius:10px; height:25px; width:180px" id="fillCurrentBtn">Use Vector RX</button>

</th></tr>



<tr><th class="red" colspan="4">
<button style="background-color:white; border-radius:10px; height:25px; width:80%" onclick="toggleTbody('rxBody')">Press this if wearing Contact lenses (Converter CL to Specs)</button>


</th>

<tbody id="rxBody" style="display:none;">

</tr>

<!-- OD -->

<tr>
  <td class="red">CL Right</td>
  <td class="red">Sph : <input type="number" step="0.25" id="cl-sph-re"></td>
  <td class="red">Cyl : <input type="number" step="0.25" id="cl-cyl-re"></td>
  <td class="red">Axis : <input type="number" step="5" min="0" max="180" id="cl-axis-re"></td>
</tr>
<tr>
  <td class="red">CL Left</td>
  <td class="red">Sph : <input type="number" step="0.25" id="cl-sph-le"></td>
  <td class="red">Cyl : <input type="number" step="0.25" id="cl-cyl-le"></td>
  <td class="red">Axis : <input type="number" step="5" min="0" max="180" id="cl-axis-le"></td>
</tr>

<tr><td class="red">

<button class="greyonclick" style="background-color:white; border-radius:10px; height:25px; width:90px" onclick="convertToSpecs()">Convert</button>

<button class="greyonclick" style="margin-top:1%; background-color:white; border-radius:10px; height:25px; width:90px" onclick="autofillOriginalInputs()">Use This RX</button>

</td>
<td  class="red"colspan="3">
  R : <span style="margin-right:100px"id="reResult">0.00 / 0.00 x 0</span> 
  L : <span id="leResult">0.00 / 0.00 x 0</span>
</td>
</tr>
</tbody>



<!-- OD -->

<tr>
  <td>Specs Right</td>
  <td>Sph : <input type="number" step="0.25" id="od_origS"></td>
  <td>Cyl : <input type="number" step="0.25" id="od_origC"></td>
  <td>Axis : <input type="number" step="5" min="0" max="180" id="od_origA"></td>
</tr>
<tr>
  <td>Specs Left</td>
  <td>Sph : <input type="number" step="0.25" id="os_origS"></td>
  <td>Cyl : <input type="number" step="0.25" id="os_origC"></td>
  <td>Axis : <input type="number" step="5" min="0" max="180" id="os_origA"></td>
</tr>
<tr>
  <td>Near Vision</td>
  <td >Add : <input type="number" step="0.25" min="0" max="5" id="nearAdd"></td>
  <td style="text-align:left" colspan="2"><span style="margin-left:5%">Age :</span> <input type="number" step="1" min="1" max="100" id="age">
<span style="margin-left:2%" id="addComment"><i>Key in age to see normal add</i></span></td>
</tr>

<tr><td colspan="4"><span>Overcorrection Predictor : </span><span id="overcorrectionComment"> - </td>
</tr>


<script>
function analyzeAgeAdd() {
  const age = parseInt(document.getElementById("age").value);
  let add = "";

  if (!age || age < 1) {
    add = "Enter a valid age.";
  } else if (age < 37) {
    add = "Normal add is +0.00";
  } else if (age < 43) {
    add = "Normal add is +0.25 to +0.50";
  } else if (age < 45) {
    add = "Normal add is +0.50 to +0.75";
  } else if (age < 47) {
    add = "Normal add is +0.75 to +1.00";
  } else if (age < 49) {
    add = "Normal add is +1.00 to +1.25";
  } else if (age < 51) {
    add = "Normal add is +1.25 to +1.50";
  } else if (age < 53) {
    add = "Normal add is +1.50 to +1.75";
  } else if (age < 55) {
    add = "Normal add is +1.75 to +2.00";
  } else if (age < 57) {
    add = "Normal add is +2.00 to +2.25";
  } else if (age < 59) {
    add = "Normal add is +2.25 to +2.50";
  } else if (age < 61) {
    add = "Normal add is +2.50";
  } else {
    add = "Normal add is +2.50";
  }

  document.getElementById("addComment").innerText = add;

  const nearAddVal = parseFloat(document.getElementById("nearAdd").value);
  if (nearAddVal) {
    checkOvercorrection(add);
  } else {
    document.getElementById("overcorrectionComment").innerText = "";
  }
}

function parseNormalAdd(normalAddStr) {
  const match = normalAddStr.match(/\+([\d.]+)/g);
  if (!match) return 0;
  const values = match.map(s => parseFloat(s.replace("+","")));
  return { min: Math.min(...values), max: Math.max(...values) };
}

function checkOvercorrection(normalAddStr) {
  const normalAdd = parseNormalAdd(normalAddStr);
  const nearAdd = parseFloat(document.getElementById("nearAdd").value);
  const commentEl = document.getElementById("overcorrectionComment");

  if (!nearAdd) {
    commentEl.innerText = "";
  } 
  // Overcorrection
  else if (nearAdd > normalAdd.max) {
    const diffMin = (nearAdd - normalAdd.max).toFixed(2);
    const diffMax = (nearAdd - normalAdd.min).toFixed(2);
    commentEl.innerText = `Possible overcorrection by +${diffMin} to +${diffMax}`;
    commentEl.style.color = "red";
  } 
  // Below normal
  else if (nearAdd < normalAdd.min) {
    const diffMin = (normalAdd.min - nearAdd).toFixed(2);
    const diffMax = (normalAdd.max - nearAdd).toFixed(2);
    commentEl.innerText = `Near add below normal by +${diffMin} to +${diffMax}`;
    commentEl.style.color = "green";
  } 
  // Within range
  else {
    commentEl.innerText = "Near add within normal range";
    commentEl.style.color = "green";
  }
}

// Trigger when age changes
document.getElementById("age").addEventListener("input", analyzeAgeAdd);

// Trigger when nearAdd changes
document.getElementById("nearAdd").addEventListener("input", function() {
  const normalAddStr = document.getElementById("addComment").innerText;
  if (normalAddStr.includes("Normal add")) {
    checkOvercorrection(normalAddStr);
  } else {
    document.getElementById("overcorrectionComment").innerText = "";
  }
});
</script>


<tr><th class="red" colspan="4">Current Fitting Details - <i>Measure the PD and the NOC (middle of nosepad to optical center)</i></th></tr>
<tr>
  <td>Right</td>
  <td>PD : <input type="number" step="0.25" id="od_PD"></td>
  <td>NOC : <input type="number" step="0.25" id="od_NOC"></td>
  <td><button type="button" onclick="copyRightToLeft()">Copy to Left</button>
</td>
</tr>
<tr>
  <td>Left</td>
  <td>PD : <input type="number" step="0.25" id="os_PD"></td>
  <td>NOC : <input type="number" step="0.25" id="os_NOC"></td>
  <td>-</td>
</tr>
<tr>
<td>Lens Details</td>
<td colspan="3">
<div>
<input type="text" id="current_lens_details"
  style="text-align:left; width:95%; height:20px"
  placeholder="Index , Type of Vision , Corridor">
</div>
<div style="text-align:left; margin-left:2%; margin-top:1%;">
<span>1. Index : 1.56 , 1.61 , 1.67 , 1.74</span><br> 
<span>2. Vision Type : SV , MF , Relax , Office</span><br>
<span>3. Purpose : See Far, See Near, See Intermediate, See everything</span><br>
<span>4. Corridor (for MF only) : Short, Medium, Long</span>

</div>
</td>
</tr>

<script>
function copyRightToLeft(){
  document.getElementById("os_PD").value  = document.getElementById("od_PD").value;
  document.getElementById("os_NOC").value = document.getElementById("od_NOC").value;
}
</script>



<tr><th class="red" colspan="4">Please Press Update All! 
<button style="margin-left:10px; border-radius:10px; height:25px; width:100px" class="updateAllBtn">Update All</button>
</th></tr>

<tr>
<td colspan="1">Comments:</td>
<td colspan="3">
<input type="text" id="current_comments1"
  style="text-align:left; width:95%; height:20px"
  placeholder="Purpose of prescription; Far? Near? Contact lens? etc"
  oninput="updateCurrentSummary()">
<div style="height:5px"></div>

<input type="text" id="current_comments2"
  style="text-align:left; width:95%; height:20px"
  placeholder="Any special plan for this prescription?"
  oninput="updateCurrentSummary()">
<div style="height:5px"></div>

<input type="text" id="current_comments3"
  style="text-align:left; width:95%; height:20px"
  placeholder="Leave empty if not used"
  oninput="updateCurrentSummary()">
<div style="height:5px"></div>

<input type="text" id="current_comments4"
  style="text-align:left; width:95%; height:20px"
  placeholder="Leave empty if not used"
  oninput="updateCurrentSummary()">
<div style="height:5px"></div>


</td></tr>



</table>
</div>

    <div id="s2" class="section">
<div style="height:70px"></div>


<table>
<!-- Vector Refraction -->
<tr>
  <th class="yellow" colspan="4">Vector Refraction</th></tr>
<tr><td colspan="4"><b><i> Instructions to fill FC DC Bal </i></b><br><br>1. Measure and input the amount of sph needed to shift DC to balance.<br>2. Calculate fogging (+1.00 + DC Bal) for FC test.<br>3. Apply fogging, measure and input the amount of cyl and axis needed to balance FC.<br>4. Press USE to transfer details to Vector Changes. </td></tr>
<tr>
  <td>FC DC Bal BE<br><div style="margin-top:5px"><button onclick="copyVD_OU_to_ODOS()" style="border-radius:10px; width:70px; height:25px">Use BE</button></div></td>
  <td>
     Sph : <input type="number" step="0.25" id="vd_ouS"><br>
    <div style="margin-top:2px"><span style="margin-right:15px" id="vd_out_ouS">-</span></div>
  </td>
  <td>
    Cyl : <input type="number" step="0.25" id="vd_ouC"><br>
    <div style="margin-top:2px"><span style="margin-right:15px" id="vd_out_ouC">-</span></div>
  </td>
  <td>
    Axis : <input type="number" step="5" min="0" max="180" id="vd_ouA"><br>
    <div style="margin-top:2px"><span style="margin-right:15px" id="vd_out_ouA">-</span></div>
  </td>
</tr>

<tr>
  <td>FC DC Bal R<br><div style="margin-top:5px"><button onclick="copyVD_OD()" style="border-radius:10px; width:70px; height:25px">Use RE</button></div></td>
  <td>
     Sph : <input type="number" step="0.25" id="vd_odS"><br>
    <div style="margin-top:2px"><span style="margin-right:15px" id="vd_out_odS">-</span></div>
  </td>
  <td>
    Cyl : <input type="number" step="0.25" id="vd_odC"><br>
    <div style="margin-top:2px"><span style="margin-right:15px" id="vd_out_odC">-</span></div>
  </td>
  <td>
    Axis : <input type="number" step="5" min="0" max="180" id="vd_odA"><br>
    <div style="margin-top:2px"><span style="margin-right:15px" id="vd_out_odA">-</span></div>
  </td>
</tr>

<tr>
  <td>FC DC Bal L<br>
    <div style="margin-top:5px">
      <button onclick="copyVD_OS()" style="border-radius:10px; width:70px; height:25px">Use LE</button>
    </div>
  </td>
  <td>
    Sph : <input type="number" step="0.25" id="vd_osS"><br>
    <div style="margin-top:2px"><span style="margin-right:15px" id="vd_out_osS">-</span></div>
  </td>
  <td>
    Cyl : <input type="number" step="0.25" id="vd_osC"><br>
    <div style="margin-top:2px"><span style="margin-right:15px" id="vd_out_osC">-</span></div>
  </td>
  <td>
    Axis : <input type="number" step="5" min="0" max="180" id="vd_osA"><br>
    <div style="margin-top:2px"><span style="margin-right:15px" id="vd_out_osA">-</span></div>
  </td>

</tr>
<tr style="border:none; height:10px;">
  <td style="border:none; height:1px; padding:0;"></td>
  <td style="border:none; height:1px; padding:0;"></td>
  <td style="border:none; height:1px; padding:0;"></td>
  <td style="border:none; height:1px; padding:0;"></td>
</tr>

<tr>
  <td>Vector Changes R<br>
<button style="border-radius:10px; margin-right:5%; color:green" type="button" onclick="adjustValue('vc_odS', 0.25)">+0.25</button>
<button style="border-radius:10px; color:red" type="button" onclick="adjustValue('vc_odS', -0.25)">-0.25</button>

</td>
  <td><input type="number" step="0.25" id="vc_odS"></td>
  <td><input type="number" step="0.25" id="vc_odC"></td>
  <td><input type="number" step="5" min="0" max="180" id="vc_odA"></td>
</tr>
<tr>
  <td>Vector Changes L<br>
<button style="border-radius:10px; color:green; margin-right:5%" type="button" onclick="adjustValue('vc_osS', 0.25)">+0.25</button>
<button style="border-radius:10px; color:red" type="button" onclick="adjustValue('vc_osS', -0.25)">-0.25</button>

</td>
  <td><input type="number" step="0.25" id="vc_osS"></td>
  <td><input type="number" step="0.25" id="vc_osC"></td>
  <td><input type="number" step="5" min="0" max="180" id="vc_osA"></td>
</tr>
<tr >
  <td>Bino Imbalance</td>
  <td id="vc_crossS">-</td>
  <td id="vc_crossC">-</td>
  <td id="vc_crossA">-</td>
</tr>

<tr style="border:none; height:10px;">
  <td style="border:none; height:1px; padding:0;"></td>
  <td style="border:none; height:1px; padding:0;"></td>
  <td style="border:none; height:1px; padding:0;"></td>
  <td style="border:none; height:1px; padding:0;"></td>
</tr>

<tr>
<td class="red">Current RX</td>
<td class="red" colspan="3">
R: <span class="od_summary" style="margin-right: 80px;">+0.00 / +0.00 × 0</span>
L: <span class="os_summary">+0.00 / +0.00 × 0</span>
</td>
</tr>
<tr style="display:">
  <td class="yellow">Vector RX</td>
  <td class="yellow" colspan="3">
R: <span id="od_vcFinalS">0.00</span> / <span id="od_vcFinalC">0.00</span> x <span id="od_vcFinalA">-</span><span style="margin-left:80px"></span>
L: <span id="os_vcFinalS">0.00</span> / <span id="os_vcFinalC">0.00</span> x <span id="os_vcFinalA">-</span>

</td>
</tr>


<tr>
<td class="yellow">Add : <input style="width:60px" type="number" step="0.25" min="0" max="5" id="nearAddVector"
</td>


<td colspan="3" class="yellow">
    R: <span id="od_vcNearCombined" style="margin-right: 80px;">0.00 / 0.00 x 0</span>
    L: <span id="os_vcNearCombined">0.00 / 0.00 x 0</span>

</td>

</tr>


<tr><th class="yellow" colspan="4">Please Press Update All! 
<button style="margin-left:10px; border-radius:10px; height:25px; width:100px" class="updateAllBtn">Update All</button>
<br><br>
Status : <button id="statusVector"
        data-value="Not Done - Invalid"
        style="font-size:11px; border-radius:10px; height:25px; margin-left:2px; width:120px"
        onclick="toggleStatusVector()">
  Not Done - Invalid
</button>
<script>
function toggleStatusVector() {
  const btn = document.getElementById("statusVector");

  if (btn.dataset.value === "Not Done - Invalid") {
    btn.dataset.value = "done";
    btn.textContent = "Done - Valid";
    btn.style.backgroundColor = "#444";
    btn.style.color = "white";
  } else {
    btn.dataset.value = "Not Done - Invalid";
    btn.textContent = "Not Done - Invalid";
    btn.style.backgroundColor = ""; // revert to original
    btn.style.color = "";           // revert to original
  }
}
</script>



<button style="margin-left:10px; border-radius:10px; height:25px; width:65px" class="exportBtn">
    Save
  </button>
</th></tr>




<tr>
<td colspan="1">Comments:</td>
<td colspan="3">
<input type="text" id="vector_comments1"
  style="text-align:left; width:95%; height:20px"
  placeholder="Purpose of prescription; Far? Near? Contact lens? etc"
  oninput="updateVectorSummary()">
<div style="height:5px"></div>

<input type="text" id="vector_comments2"
  style="text-align:left; width:95%; height:20px"
  placeholder="Any special plan for this prescription?"
  oninput="updateVectorSummary()">
<div style="height:5px"></div>

<input type="text" id="vector_comments3"
  style="text-align:left; width:95%; height:20px"
  placeholder="Leave empty if not used"
  oninput="updateVectorSummary()">
<div style="height:5px"></div>

<input type="text" id="vector_comments4"
  style="text-align:left; width:95%; height:20px"
  placeholder="Leave empty if not used"
  oninput="updateVectorSummary()">
<div style="height:5px"></div>


</td></tr>

</table>
</div>
<div style="height:50px"></div>


    <div id="s3" class="section">
<div style="height:70px"></div>

<table>
<!-- Manual Subjective Refraction -->
<tr><th class="blue" colspan="4">

Manual Refraction


</th></tr>


<tr><td colspan="4"><b><i>
<b><i>Troubleshooter</b></i><br>  
Use this to know what RX to fit next based on patient's response.
</b></i><br>
1. Key in the current prescription.<br>
2. Key in their response of the FC and DC.<br>
3. Press calculate prescription.<br>
4. Refill the new prescription to the top by pressing the 'Copy to Top'.<br>
<br><br> 


  <!-- Inputs -->
  <div class="row">
    <label>SPH : <input id="TS_sph" type="number" step="0.25"></label>
    <label>CYL : <input id="TS_cyl" type="number" step="0.25" ></label>
    <label>AXIS : <input id="TS_axis" type="number" step="5" min="0" max="180"></label>
</div>

<br>
  <div style="margin-top:15px" class="row">
    <button style="width:33%; margin-right:2%" onclick="runAllCalculations()">Calculate RX</button>

    <button style="width:18%; margin-right:2%"id="lockFinalBtn">Save to List</button>
    <button style="width:18%; "id="resetBtn">Reset to 0</button>
  </div><br>

  <!-- Dropdowns -->
  <div class="row">
    <div>
      <label>Duochrome : </label>
      <select style="width:50%" id="duochrome">
        <option value="">--Select--</option>
        <option value="both_badly">Both badly blur - 6 / 9 unreadable </option>
        <option value="both_moderately">Both little blur - 6 / 9 readable but shadowy</option>
        <option value="red">Red clearer</option>
        <option value="blue">Blue clearer</option>
        <option value="both_clear">Both clear</option>
      </select>
    </div><br>

    <div>
      <label>Fan Chart : </label>
      <select style="width:50%" id="fanchart">
        <option value="">--Select--</option>
        <option value="all_blur">All same quality / no darker line</option>
        <option value="one_clearer">One direction clearer</option>
        <option value="multiple_clear_blur">Multiple clear / blur (no single line pattern)</option>
      </select>
    </div><br>


    <div>
      <label>Darker Axis : </label>
      <select style="width:50%" id="axisDarker"></select>
    </div>
  </div><br>

  <div style="height:90px" id="result"><i>- Press Calculate RX to see Results -</div>
  </table>


  <table style="border-top:none" id="finalTable">
    <thead>
      <tr id="finalTable" class="red">
         <th class="red" style="width:50%">List of RX from Troubleshooter</th>
        <th class="red" style="width:40%">Notes</th>
      </tr>
    </thead>
    <tbody></tbody>
</table>



<table>
<tr><th class="red" colspan="4"> Finalized Manual RX </th></tr>

<tr class="mask1">
  <td>Right RX</td>
  <td>Sph : <input type="number" step="0.25" id="od_finalS"></td>
  <td>Cyl : <input type="number" step="0.25" id="od_finalC"></td>
  <td>Axis : <input type="number" step="5" min="0" max="180" id="od_finalA"></td>
</tr>
<tr class="mask1">
  <td>Left RX</td>
  <td>Sph : <input type="number" step="0.25" id="os_finalS"></td>
  <td>Cyl : <input type="number" step="0.25" id="os_finalC"></td>
  <td>Axis : <input type="number" step="5" min="0" max="180" id="os_finalA"></td>
</tr>
<tr class="mask1">
  <td>Right FC DC</td>
  <td id="od_roundS"></td>
  <td id="od_roundC"></td>
  <td id="od_roundA"></td>
</tr>

<tr class="mask1">
  <td>Left FC DC</td>
  <td id="os_roundS"></td>
  <td id="os_roundC"></td>
  <td id="os_roundA"></td>
</tr>
<tr class="mask1">
  <td>Bino Imbalance</td>
  <td id="diffCrossS"></td>
  <td id="diffCrossC"></td>
  <td id="diffCrossA"></td>
</tr>


<tr style="display:none" class="mask1">
  <td colspan="1">Crossed OD</td>
  <td id="od_crossS"></td>
  <td id="od_crossC"></td>
  <td id="od_crossA"></td>
</tr>
<tr style="display:none" class="mask1">
  <td colspan="1">Crossed OS</td>
  <td id="os_crossS"></td>
  <td id="os_crossC"></td>
  <td id="os_crossA"></td>
</tr>

<tr style="border:none; height:10px;">
  <td style="border:none; height:1px; padding:0;"></td>
  <td style="border:none; height:1px; padding:0;"></td>
  <td style="border:none; height:1px; padding:0;"></td>
  <td style="border:none; height:1px; padding:0;"></td>
</tr>
<tr><th class="red" colspan="4"> Vectorized Corrected </th></tr>
<tr class="mask1">
<td class="red">Current Rx</td>
<td class="red" colspan="3">
R: <span class="od_summary" style="margin-right: 80px;">+0.00 / +0.00 × 0</span>
L: <span class="os_summary">+0.00 / +0.00 × 0</span>
</td>

<tr class="mask1">
  <td>Right Dominant</td>
  <td colspan="3">
R: <span id="od_vectorDisplay" style="margin-right: 80px;">- / - × -</span>
L: <span id="OScrossedSpan">- / - × -</span>

</td>
</tr>

<tr class="mask1">
  <td>Left Dominant</td>
  <td colspan="3">
R: <span id="ODcrossedSpan" style="margin-right: 80px;">- / - × -</span>
L: <span id="os_vectorDisplay">- / - × -</span>

</td>
</tr>
<tr><td>
Add : <input style="width:60px" type="number" step="0.25" min="0" max="5" id="nearAddFinal"></td>

<td colspan="3">
    R: <span id="od_finalNearCombined" style="margin-right: 80px;">0.00 / 0.00 × 0</span>
    L: <span id="os_finalNearCombined">0.00 / 0.00 × 0</span>
</td>

</tr>
<tr><th class="blue" colspan="4">Please Press Update All! 
<button style="margin-left:10px; border-radius:10px; height:25px; width:100px" class="updateAllBtn">Update All</button>
<br><br>
Status : <button id="statusManual"
        data-value="Not Done - Invalid"
        style="font-size:11px; border-radius:10px; height:25px; margin-left:2px; width:120px"
        onclick="toggleStatusManual()">
  Not Done - Invalid
</button>
<script>
function toggleStatusManual() {
  const btn = document.getElementById("statusManual");
  if (btn.dataset.value === "Not Done - Invalid") {
    btn.dataset.value = "done";
    btn.textContent = "Done - Valid";
    btn.style.backgroundColor = "#444";
    btn.style.color = "white";
  } else {
    btn.dataset.value = "Not Done - Invalid";
    btn.textContent = "Not Done - Invalid";
    btn.style.backgroundColor = ""; // revert to original
    btn.style.color = "";           // revert to original
  }
}
</script>

<button style="margin-left:10px; border-radius:10px; height:25px; width:65px" class="exportBtn">
    Save
  </button>

</th>
</tr>


<tr class="mask1">
<td colspan="1">Comments:</td>
<td colspan="3">
<input type="text" id="manual_comments1"
  style="text-align:left; width:95%; height:20px"
  placeholder="Purpose of prescription; Far? Near? Contact lens? etc"
  oninput="updateManualSummary()">
<div style="height:5px"></div>

<input type="text" id="manual_comments2"
  style="text-align:left; width:95%; height:20px"
  placeholder="Any special plan for this prescription"
  oninput="updateManualSummary()">
<div style="height:5px"></div>

<input type="text" id="manual_comments3"
  style="text-align:left; width:95%; height:20px"
  placeholder="Leave empty if not used"
  oninput="updateManualSummary()">
<div style="height:5px"></div>

<input type="text" id="manual_comments4"
  style="text-align:left; width:95%; height:20px"
  placeholder="Leave empty if not used"
  oninput="updateManualSummary()">
<div style="height:5px"></div>

</td>
</tr>

</table>

</div>

<div style="height:300px"></div>

    <div id="s4" class="section">
<div style="height:70px"></div>

<div style="margin-top:20px; display:flex; justify-content:center; gap:7px;">

  <button class="blue" style="border-radius:10px; height:25px; width:70px" id="toggleMask1_copy">
    Manual
  </button>

<button class="yellow toggleMask2" style="border-radius:10px; height:25px; width:70px">
  Vector
</button>

<button class="toggleMask4" style="border-radius:10px; height:25px; width:70px">
  Fitting
</button>

<button style="border-radius:10px; height:25px; width:85px" class="updateAllBtn">Update All</button>

<button style="border-radius:10px; height:25px; width:85px"  onclick="capturePart()">Save JPG</button>

<button style="border-radius:10px; height:25px; width:85px" class="exportBtn">
    Save Data </button>

</div>

<div id="captureTarget">

<table>

<tr><th colspan="4" >Summary for <span id="customerName_summary"></span>
<span id="todayDate"></span>
</th></tr>
<tr style="border:none; height:10px;">
  <td style="border:none; height:1px; padding:0;"></td>
  <td style="border:none; height:1px; padding:0;"></td>
  <td style="border:none; height:1px; padding:0;"></td>
  <td style="border:none; height:1px; padding:0;"></td>
</tr>



<tr><th colspan="4">Far & Near Rx</th></tr>
<tr>
  <td class="red">Current Rx</td>
  <td colspan="3" class="red">

    R: <span id="od_origCombined" style="margin-right: 100px;">OD -</span>
    L: <span id="os_origCombined">OS -</span>
  </td>
</tr>
<tr>
  <td class="red">Current Near +<span id="mirrorNearAdd"></span> </td>
  <td style="text-align:middle" class="red" colspan="3">
  
    R: <span id="od_nearCombined" style="margin-right: 100px;">0.00 / 0.00 x 0</span>
    L: <span id="os_nearCombined">0.00 / 0.00 x 0</span>
  </td>
</tr>

<tr>
  <td class="red">Current CL Rx</td>
  <td colspan="3" class="red">

R : <span id="CL_od_origCombined" style="margin-right: 100px;">OD -</span>
L : <span id="CL_os_origCombined">OS -</span>
  </td>
</tr>

<tr class="mask2">
  <td class="yellow">Vector Rx</td>
  <td class="yellow" colspan="3">
    R : <span id="od_vcCombined" style="margin-right: 100px;">-</span>
    L : <span id="os_vcCombined">-</span>
  </td>
</tr>

<tr class="mask2">
  <td class="yellow">Vector Near +<span id="mirrorNearAddVector"></span>
</td>
  <td style="text-align:middle" class="yellow" colspan="3">
    R: <span id="od_vcNearCombined_mirror" style="margin-right: 100px;">0.00 / 0.00 x 0</span>
    L: <span id="os_vcNearCombined_mirror">0.00 / 0.00 x 0</span>
  </td>
</tr>

<tr class="mask2">
  <td class="yellow">Vector CL Rx</td>
  <td class="yellow" colspan="3">
    R : <span id="CL_od_vcCombined" style="margin-right: 100px;">-</span>
    L : <span id="CL_os_vcCombined">-</span>
  </td>
</tr>

<tr class="mask1">
  <td class="blue">Manual Rx</td>
  <td class="blue" colspan="3">
    R : <span id="od_finalCombined" style="margin-right: 100px;">OD -</span>
    L : <span id="os_finalCombined">OS -</span>
  </td>
</tr>
<tr class="mirror1 mask1">
  <td class="blue">Vectorized RE Dom</td>
  <td class="blue" colspan="3">
    R: <span id="od_vectorDisplay_mirror" style="margin-right: 80px;">- / - × -</span>
    L: <span id="os_vectorDisplay_mirror">- / - × -</span>
  </td>
</tr>

<tr class="mirror2 mask1">
  <td class="blue">Vectorized LE Dom</td>
  <td class="blue" colspan="3">
    R: <span id="ODcrossedSpan_mirror" style="margin-right: 80px;">- / - × -</span>
    L: <span id="OScrossedSpan_mirror">- / - × -</span>
  </td>
</tr>

<tr class="mask1">
  <td class="blue">Manual Near +<span id="mirrorNearAddFinal"></span>
</td>
  <td style="text-align:middle" class="blue" colspan="3">
    R: <span id="od_finalNearCombined_mirror" style="margin-right: 100px;">0.00 / 0.00 × 0</span>
    L: <span id="os_finalNearCombined_mirror">0.00 / 0.00 × 0</span>
  </td>
</tr>

<tr class="mask1">
  <td class="blue">Manual CL Rx</td>
  <td class="blue" colspan="3">
    R : <span id="CL_od_finalCombined" style="margin-right: 100px;">OD -</span>
    L : <span id="CL_os_finalCombined">OS -</span>
  </td>
</tr>


<tr style="border:none; height:10px;">
  <td style="border:none; height:1px; padding:0;"></td>
  <td style="border:none; height:1px; padding:0;"></td>
  <td style="border:none; height:1px; padding:0;"></td>
  <td style="border:none; height:1px; padding:0;"></td>
</tr>


<tr class="mask4"><th colspan="4">New Fitting Details</th></tr>

<tr class="mask4"><td>Right</td>

<td colspan="3">

PD : <span class="mirror" data-mirror="od_PD">-</span> mm  <span style="margin-left:15%; margin-right:15%"> ; </span> NOC : <span class="mirror" data-mirror="od_NOC">-</span> mm 
</td></tr>
<tr class="mask4"><td>Left</td>

<td colspan="3">

PD : <span class="mirror" data-mirror="os_PD">-</span> mm  <span style="margin-left:15%; margin-right:15%"> ; </span> NOC : <span class="mirror" data-mirror="os_NOC">-</span> mm 
</td></tr>

<tr class="mask4"><td>New Lens Details</td>
<td colspan="3">
<div>
<input type="text" id="new_lens_details"
  style="text-align:left; width:95%; height:20px"
  placeholder="Index , Type of Vision , Purpose of Vision, Corridor">
</div>
<div style="text-align:left; margin-left:2%; margin-top:1%;">
<span>1. Index : 1.56 , 1.61 , 1.67 , 1.74</span><br> 
<span>2. Vision Type : SV , MF , Relax , Office</span><br>
<span>3. Purpose : See Far, See Near, See Intermediate, See everything</span><br>
<span>4. Corridor (for MF only) : Short, Medium, Long</span>

</div>
</td>
</tr>
<tr style="border:none; height:10px;">
  <td style="border:none; height:1px; padding:0;"></td>
  <td style="border:none; height:1px; padding:0;"></td>
  <td style="border:none; height:1px; padding:0;"></td>
  <td style="border:none; height:1px; padding:0;"></td>
</tr>
<tr><th colspan="4">Comments</th></tr>
<tr class="mask2">
<td class="red">Current</td><td colspan="3" class="red"><span id="current_comments_summary"></span>
</td></tr>

<tr class="mask2">
<td class="yellow">Vector</td><td colspan="3" class="yellow"><span id="vector_comments_summary"></span>
</td></tr>

<tr class="mask1">
<td class="blue">Manual</td><td colspan="3" class="blue"><span id="manual_comments_summary"></span>
</td></tr>

<tr style="border:none; height:10px;">
  <td style="border:none; height:1px; padding:0;"></td>
  <td style="border:none; height:1px; padding:0;"></td>
  <td style="border:none; height:1px; padding:0;"></td>
  <td style="border:none; height:1px; padding:0;"></td>
</tr>

</table>

</div>


<div style="width:80%; margin-top:10px;">
  <div style="display:flex; flex-direction:column; align-items:center;">

  <textarea style="display:none" id="rxExportBox"
    style="max-width:550px; width:99%; height:20px; margin-top:10px;">
  </textarea>
</div>
</div>







   <div id="s1" class="section">
<div style="height:70px"></div>


<div style="margin-top:20px; display:flex; justify-content:center; gap:7px;">
  <button class="blue" style="border-radius:10px; height:25px; width:70px" id="toggleMask1">
    Manual
  </button>

<button class="yellow toggleMask2" style="border-radius:10px; height:25px; width:70px">
  Vector
</button>

<button class="toggleMask4" style="border-radius:10px; height:25px; width:70px">
  Fitting
</button>

<button style="border-radius:10px; height:25px; width:85px" class="updateAllBtn">Update All</button>
<button style="border-radius:10px; height:25px; width:85px"  onclick="capturePart()">Save JPG</button>
<button style="border-radius:10px; height:25px; width:85px" class="exportBtn">
    Save Data
  </button>

</div>




<table>

<tr><th colspan="4">Analysis</th></tr>
<tr style="border:none; height:10px;">
  <td style="border:none; height:1px; padding:0;"></td>
  <td style="border:none; height:1px; padding:0;"></td>
  <td style="border:none; height:1px; padding:0;"></td>
  <td style="border:none; height:1px; padding:0;"></td>
</tr>

<tr><th colspan="4">RX Change & Bino Imbalance Analysis</th></tr>

<tr class="mask2">
  <td class="yellow">FC DC Bal</td>
  <td colspan="3" class="yellow">
   BE : <span id="vd_ouSummary">-</span><br><br>
    R : <span id="vd_odSummary" style="margin-right: 30px;">-</span>
    L : <span id="vd_osSummary">-</span>
  </td>
</tr>

<tr class="mask2">
  <td class="yellow">Vector Change</td>
  <td colspan="3" class="yellow">
    R: <span id="vc_odSummary" style="margin-right: 100px;">-</span>
    L: <span id="vc_osSummary">-</span>
  </td>
</tr>

<tr class="mask1">
  <td class="blue">Manual Change</td>
  <td colspan="3" class="blue">
    R: <span id="od_roundCombinedDisplay" style="margin-right: 100px;">-</span>
    L: <span id="os_roundCombinedDisplay">-</span>
  </td>
</tr>

<tr style="border:none; height:10px;">
  <td style="border:none; height:1px; padding:0;"></td>
  <td style="border:none; height:1px; padding:0;"></td>
  <td style="border:none; height:1px; padding:0;"></td>
  <td style="border:none; height:1px; padding:0;"></td>
</tr>

<tr><th colspan="4">    <span style="display:block;">
      Gaze Imbalance (
      <span style="color:green;">Green = Good</span>,
      <span style="color:red;">Red = Discomfort</span> )

<div style="display:flex; margin-top:2%; justify-content:center; gap:1%;">
  <label>
    Gaze Angle:
    <input type="range" id="gazeAngle" step="5" value="35" min="10" max="50" 
           oninput="this.nextElementSibling.value = this.value" style="vertical-align: middle; width:45%">
    <output style="vertical-align: middle;">35</output>
  </label>

  <label>
    BVD (mm):
    <input type="range" id="vertexDist" step="1" value="12" min="1" max="20" 
           oninput="this.nextElementSibling.value = this.value" style="vertical-align: middle; width:45%">
    <output style="vertical-align: middle;">12</output>
  </label>
</div>
</th></tr>



<tr class="mask2">
  <td class="yellow">Vector Gaze</td>
  <td class="yellow" colspan="3">
    Horizontal : <span id="prismH_vc" style="margin-right: 50px;">-</span>
    Vertical : <span id="prismV_vc" style="margin-right: 50px;">-</span>
    Diagonal : <span id="prismD_vc">-</span>
  </td>
</tr>

<tr class="mask1">
  <td class="blue">Manual Gaze</td>
  <td class="blue" colspan="3">
    Horizontal : <span id="prismH" style="margin-right: 50px;">-</span>
    Vertical : <span id="prismV" style="margin-right: 50px;">-</span>
    Diagonal : <span id="prismD">-</span>
  </td>
</tr>

<tr style="border:none; height:10px;">
  <td style="border:none; height:1px; padding:0;"></td>
  <td style="border:none; height:1px; padding:0;"></td>
  <td style="border:none; height:1px; padding:0;"></td>
  <td style="border:none; height:1px; padding:0;"></td>
</tr>

<tr><th colspan="4">Blur Value <button class="toggleMask3" style="border-radius:10px; margin-left:3%; height:25px; width:130px">
  Hide/Show
</button></th></tr>

<tr class="mask3 hidden-row">
<td colspan="4">
<div>
Prescription comes in many types of errors; whether it's myopia, hyperopia or astigmatism.<br>The test works by measuring the blur, then correcting your vision with the amount.<br><br>

</div>  

<div>
  <button style="width:75%" onclick="resetRx()">Reset</button>
</div>
<!-- Participant Inputs -->
  <div style="width:100%; display:flex; justify-content:center; gap:10px; flex-wrap:wrap; align-items:flex-start; margin-top:10px;">



    <!-- SPH -->
    <div style="text-align:center;">
      <label><b>SPH</b></label><br>
      <input type="number" id="sph" step="0.25" value="0.00" class="rx-input"><br>
      <div>
        <button onclick="adj('sph',-0.25)" class="btn-minus">−0.25</button>
        <button onclick="adj('sph', 0.25)" class="btn-plus">+0.25</button><br>
        <button onclick="adj('sph',-0.50)" class="btn-minus">−0.50</button>
        <button onclick="adj('sph', 0.50)" class="btn-plus">+0.50</button><br>
       </div>
    </div>

    <!-- CYL -->
    <div style="text-align:center;">
      <label><b>CYL</b></label><br>
      <input type="number" id="cyl" step="0.25" value="0.00" class="rx-input"><br>
      <div>
        <button onclick="adj('cyl',-0.25)" class="btn-minus">−0.25</button>
        <button onclick="adj('cyl', 0.25)" class="btn-plus">+0.25</button><br>
        <button onclick="adj('cyl',-0.50)" class="btn-minus">−0.50</button>
        <button onclick="adj('cyl', 0.50)" class="btn-plus">+0.50</button><br>

      </div>
    </div>

    <!-- AXIS -->
    <div style="text-align:center;">
      <label><b>AXIS</b></label><br>
      <input type="number" id="axis" min="0" step="1" value="180" class="rx-input"><br>
      <div>
        <button onclick="adj('axis', -1)"  class="btn-minus">−1</button>
        <button onclick="adj('axis',  1)"  class="btn-plus">+1</button><br>        
	<button onclick="adj('axis', -10)"  class="btn-minus">−10</button>
        <button onclick="adj('axis',  10)"  class="btn-plus">+10</button><br>
      </div>
    </div>
  </div>

<div style="
  display:grid;
  grid-template-columns: repeat(3, 25%);
  gap:10px;
  justify-content:center;
  margin-top:12px;
">
  <button style="width:100%" onclick="highlightRx(this,'sph',-1.00)">Near-Sighted</button>
  <button style="width:100%" onclick="highlightRx(this,'sph',1.00)">Far-Sighted</button>
  <button style="width:100%" onclick="highlightRx(this,'cyl',-1.00)">Astig</button>
  <button style="width:100%" onclick="highlightRx(this,'sph',-2.00)">High Near-Sighted</button>
  <button style="width:100%" onclick="highlightRx(this,'sph',2.00)">High Far-Sighted</button>
  <button style="width:100%" onclick="highlightRx(this,'cyl',-2.00)">High Astig</button>
</div>

<style>
  .rx-active { background:#ccc; }
</style>

<script>
let activeBtn = { sph: null, cyl: null };

// Your original setRx function
function setRx(field, value){
  const el = document.getElementById(field);
  el.value = Number(value).toFixed(2);

  // force same behavior as clicking +/- buttons
  el.dispatchEvent(new Event('input', { bubbles:true }));
  el.dispatchEvent(new Event('change', { bubbles:true }));

  if (typeof updateAll === 'function') updateAll();
  if (typeof redraw === 'function') redraw();
}

// New wrapper for highlighting + calling setRx
function highlightRx(btn, field, value){
  if(activeBtn[field]) activeBtn[field].classList.remove('rx-active');
  btn.classList.add('rx-active');
  activeBtn[field] = btn;

  setRx(field, value);
}

// Reset everything
function resetRx(){
  if(activeBtn.sph) activeBtn.sph.classList.remove('rx-active');
  if(activeBtn.cyl) activeBtn.cyl.classList.remove('rx-active');
  activeBtn.sph = null;
  activeBtn.cyl = null;

  setRx('sph', 0.00);
  setRx('cyl', 0.00);
  setRx('axis', 180);
}
</script>



</div>
<div style="height:20px"></div>

<!-- Stage -->
<div id="stage">
  <!-- Fan Chart -->
  <div id="stack" style="position:relative; width:44%; height:auto ; margin:0 0 0px 0;">
    <img class="bg" src="https://raw.githubusercontent.com/kiaraoptometrypx/Trainer/main/FC_DIRECTIONS.png" alt="" style="width:100%; display:block;" />
    <div class="overlay" style="position:absolute; inset:0; display:flex; align-items:center; justify-content:center; pointer-events:none;">
      <div class="overlay-stage">
        <div class="outer-circle" id="outerCircle" style="width:100%; aspect-ratio:1/1; border-radius:9999px; overflow:hidden;">
          <div class="circular-img" style="width:100%; height:100%;">
            <img id="fanChart" src="https://raw.githubusercontent.com/kiaraoptometrypx/Trainer/main/C000.png" alt="" style="width:100%; height:100%; object-fit:cover;" />
          </div>
        </div>
      </div>
    </div>
  </div>

 <!-- Duochrome (button above) -->
<div class="duo-wrap">
  <div class="duochrome">
    <div class="duo-side" id="redSide">
      <img class="base" id="redImg"  src="https://raw.githubusercontent.com/kiaraoptometrypx/Trainer/main/RED_1.png"  alt="">
<img class="overlay" id="redOv" src="https://raw.githubusercontent.com/kiaraoptometrypx/Trainer/main/RED_1.png" alt="">
    </div>
    <div class="duo-side" id="blueSide">
      <img class="base" id="blueImg" src="https://raw.githubusercontent.com/kiaraoptometrypx/Trainer/main/BLUE_1.png" alt="">
<img class="overlay" id="blueOv" src="https://raw.githubusercontent.com/kiaraoptometrypx/Trainer/main/BLUE_1.png" alt="">
    </div>
  </div>

</div>
</td></tr>

</table>
<div style="height:500px"></div>




   <div id="s6" class="section">
<div style="height:70px"></div>

<table>
<tr><th colspan="4">How Eyes Work</th></tr>
<tr style="border:none; height:10px;">
  <td style="border:none; height:1px; padding:0;"></td>
  <td style="border:none; height:1px; padding:0;"></td>
  <td style="border:none; height:1px; padding:0;"></td>
  <td style="border:none; height:1px; padding:0;"></td>
</tr>

<tr><th colspan="4">What is Prescription and Why we need them.</th></tr>

<tr><td colspan="4">  

<div style="padding:0% 8% 2% 8%; text-align:left; line-height:1.5">&bull; Prescription is the <b>amount of lens power needed to help you see clearly</b>.<br>
&bull; A <b>perfectly round eyeball</b> can focus light clearly and sharp without needing lenses.<br>
&bull; However, if the eyeball is <b>longer, shorter, or oval</b>, light cannot focus properly.<br>
&bull; In these cases, lenses are needed to <b>help focus the light so images appear clear and sharp</b><br>
&bull; Therefore, vision becomes the same as a perfectly round eyeball.

</div>

  <div style="flex:1; overflow:hidden;">

<img src="https://raw.githubusercontent.com/kiaraoptometrypx/OL-selector/main/Sph%20Define.png"       style="width:80%; margin-top:-10px; margin-bottom:-20px;"
 alt="Sphere Define">
</div>

<div style="height:10px"></div>

  <div style="flex:1; overflow:hidden;">

<img src="https://raw.githubusercontent.com/kiaraoptometrypx/OL-selector/main/Astig%20Define.png"       style="width:80%; margin-top:-35px; margin-bottom:-5px;"
 alt="Astig Define">


  </div>



<div style="text-align:center;">
  <div class="fade-compare" style="width:80%; margin:0 auto; position:relative;">
    <div style="position:relative; overflow:hidden; padding-top:0;">
      <img id="imgRelax" src="https://raw.githubusercontent.com/kiaraoptometrypx/OL-selector/main/relaxed_state.png" 
           style="width:100%; display:block; position:relative; margin:0 auto; clip-path: inset(20px 0 20px 0);">
      <img id="imgWork" src="https://raw.githubusercontent.com/kiaraoptometrypx/OL-selector/main/working_state.png" 
           style="width:100%; display:block; position:absolute; top:0; left:0; opacity:0; clip-path: inset(20px 0 20px 0);">
    </div>
    <input type="range" min="0" max="100" value="0" style="width:60%; margin-top:0px;">
  </div><br>
<span>Drag slider to see how your eyes work when you see Far & Near.</span>
</div>

<div style="height:20px"></div>


</td></tr>

<tr><th colspan="4">How do I know if I'm short or far-sighted?</th></tr>

<tr><td colspan="4">  

<div style="padding:0% 8% 2% 8%; text-align:left; line-height:1.5">
&bull; Incorrect lenses may allow you to see clearly but feel uneasy later on.<br>
&bull; Traditional method uses comparison and memory, asking you which lens is better.<br>
&bull; Our method removes uncertainty. We measure the blur to create a linear logic.<br>
&bull; We use the <b>Duochrome</b> to know your vision status at any moment and distance.<br>
</div>

  <div style="flex:1; overflow:hidden;">

<img src="https://raw.githubusercontent.com/kiaraoptometrypx/OL-selector/main/How%20DC%20works.png"       style="width:80%; margin-top:-65px; margin-bottom:-45px;"
 alt="How DC works">

</div>


<div style="height:10px"></div>

  <div style="flex:1; overflow:hidden;">

<img src="https://raw.githubusercontent.com/kiaraoptometrypx/OL-selector/main/How_to_tell_DC.png" style="width:80%; margin-top:-50px; margin-bottom:-20px;"
 alt="How DC works">

</div>


  <div style="display:none; flex:1; overflow:hidden;">
    <img
      src="https://raw.githubusercontent.com/kiaraoptometrypx/RX-calculator/main/DC%20Defect/Defects_type.png"
      style="width:80%; margin-top:-5px; margin-bottom:5px;"
      alt="Green DC Defect">

  </div><br>
<div style="padding:0% 8% 2% 8%; text-align:left; line-height:1.5">
&bull; <b>You will see through a series of lenses</b> and tell which side is clearer.<br>
&bull; From there, we can <b>observe a pattern on how your vision changes</b> when lenses are changed.<br>
&bull; We can then <b>prescribe according to your visual needs</b>; whether wanting to see far or near.<br>
&bull; Every pair of glasses can be adjusted <b>to function to your needs.</b><br>
</div>

<div style="height:10px"></div>
</td></tr>
<tr><th colspan="4">How do I know if I have astigmatism?</th></tr>

<tr><td colspan="4">  


<div style="padding:0% 8% 2% 8%; text-align:left; line-height:1.5">
&bull; Astigmatism happens when the <b>eye has different meridians with uneven curvature</b>.<br>
&bull; Light focuses differently along each meridian, causing <b>some to be blur and clear</b>.<br>
&bull; <b>Fanchart measures angular blur</b>, a.k.a. astigmatism.<br>

</div>
<div style="height:10px"></div>

  <div style="flex:1; overflow:hidden;">

<img src="https://raw.githubusercontent.com/kiaraoptometrypx/OL-selector/main/astig_explained.png"       style="width:80%; margin-top:0px; margin-bottom:0px;"
 alt="Astig Explained">

</div>

<div style="height:10px"></div>

  <div style="flex:1; overflow:hidden;">
    <img
      src="https://raw.githubusercontent.com/kiaraoptometrypx/RX-calculator/main/FC%20Defect/Defects_type.png"
      style="width:80%; margin-top:-10px; margin-bottom:-55px; "
      alt="FC Defect">

  </div>
<div style="height:10px"></div>
<div style="padding:0% 8% 2% 8%; text-align:left; line-height:1.5">
&bull; <b>You will see through a series of lenses</b> and tell which side is clearer.<br>
&bull; From there, we can <b>observe a pattern on how your vision changes</b> when lenses are changed.<br>
&bull; We can then <b>prescribe according to your visual needs</b>; whether wanting to see far or near.<br>
&bull; Every pair of glasses can be adjusted <b>to function to your needs.</b><br>
</div>




<div style="height:20px"></div>






</td></tr>
<tr><th colspan="4">Do I have Presbyopia? (Lou-Fa / Far-sighted / Near-Weakening)?</th></tr>

<tr><td colspan="4">  

<div style="padding:0% 8% 2% 8%; text-align:left; line-height:1.5">
&bull; <b>Presbyopia</b> is the natural weakening of near vision that happens with age.<br>
&bull; People with <b>perfect distance vision</b> will notice near objects being blur.<br>

</div>


  <div style="flex:1; overflow:hidden;">

<img src="https://raw.githubusercontent.com/kiaraoptometrypx/OL-selector/main/Presbyopia%20Define.png" style="width:80%; margin-top:-40px; margin-bottom:-60px;" alt="Presbyopia Define"> 
</div>

<div style="height:10px"></div>

<div style="padding:0% 8% 2% 8%; text-align:left; line-height:1.5">
&bull; <b>Near-sighted people</b> often do not feel presbyopia when they remove their glasses.<br>
&bull; That's because their original vision happens to be near-sighted.<br>
&bull; Not needing glasses for near does <b>not mean presbyopia is gone</b>.<br><br>

&bull; <b>Far-sighted people</b> experience presbyopia earlier than others.<br>
&bull; That's because their original vision is already challenging to see near.<br>
&bull; When younger, the eye muscles are strong enough to handle the demand.<br>
&bull; The <b>solution</b> is to wear some amount of <b>lenses at far and near to relieve</b> the total stress.<br>
&bull; The challenge is to accept that glasses have to be used every now and then.<br><br>


&bull; Wearing reading glasses or progressive lenses <b>does not make your eyes weaker</b><br>
&bull; They simply reduce eye strain and make near vision more comfortable.<br>



</div>
</td></tr>

</table>





</div>
<div style="height:750px"></div>
<div style="height:750px"></div>
<div style="height:750px"></div>








    <div id="s5" class="section">
<div style="height:70px"></div>
<table>
<tr><th colspan="4">Hypervision Lenses</th></tr>

<tr><td colspan="4">
  <div style="flex:1; overflow:hidden;">
<img src="https://raw.githubusercontent.com/kiaraoptometrypx/super_rx/main/Hyper1.png" alt="Hyper1" style="width:100%;"alt="Hyper1">
  </div>

</td></tr>
<tr><td colspan="4">
  <div style="flex:1; overflow:hidden;">
<img src="https://raw.githubusercontent.com/kiaraoptometrypx/super_rx/main/Hyper2.png" alt="Hyper2" style="width:100%;"alt="Hyper2">
  </div>
</td></tr>
<tr><td colspan="4">
  <div style="flex:1; overflow:hidden;">
<img src="https://raw.githubusercontent.com/kiaraoptometrypx/super_rx/main/Hyper3.png" alt="Hyper3" style="width:100%;"alt="Hyper3">
  </div>
</td></tr>


</table>
<div style="height: 200px"></div>



</div>

</div>



</div>



</div>
  </main>





<script>
(function () {
  const d = new Date();
  const formatted = d.toLocaleDateString("en-GB", {
    weekday: "long",
    day: "2-digit",
    month: "long",
    year: "numeric"
  });
  document.getElementById("todayDate").textContent = formatted;
})();
</script>

<script>
function updateCustomerName() {
  document.getElementById("customerName_summary").textContent =
    document.getElementById("customerName").value;
}
</script>



<script>
function mirrorById(sourceId, mirrorId) {
  const source = document.getElementById(sourceId);
  const mirror = document.getElementById(mirrorId);
  if (!source || !mirror) return;

  const sync = () => {
    mirror.textContent = source.textContent;
  };

  sync();

  new MutationObserver(sync).observe(source, {
    childList: true,
    characterData: true,
    subtree: true
  });
}

mirrorById("od_finalNearCombined", "od_finalNearCombined_mirror");
mirrorById("os_finalNearCombined", "os_finalNearCombined_mirror");
</script>

<script>
function mirrorById(sourceId, mirrorId) {
  const source = document.getElementById(sourceId);
  const mirror = document.getElementById(mirrorId);
  if (!source || !mirror) return;

  const sync = () => {
    mirror.textContent = source.textContent;
  };

  sync();

  new MutationObserver(sync).observe(source, {
    childList: true,
    characterData: true,
    subtree: true
  });
}

mirrorById("od_vcNearCombined", "od_vcNearCombined_mirror");
mirrorById("os_vcNearCombined", "os_vcNearCombined_mirror");
</script>













<script>
(function () {
  const deg2rad = d => d * Math.PI / 180;
  const rad2deg = r => r * 180 / Math.PI;
  const normAxis = a => { a = Math.round(a)%180; if(a<0)a+=180; return a; };
  const roundQuarter = v => Math.round(v*4)/4;
  const fmt = v => (Number.isFinite(v) ? (v>=0? "+" : "") + v.toFixed(2) : "-");

  function safeReadNumber(id){
    const el=document.getElementById(id);
    if(!el) return NaN;
    let raw = ('value' in el ? el.value : el.textContent ?? "").toString().trim();
    const n=parseFloat(raw);
    return Number.isFinite(n)? roundQuarter(n) : NaN;
  }

function combinePair(leftIds,rightIds){
    const sL = safeReadNumber(leftIds.s) || 0;
    const cL = safeReadNumber(leftIds.c) || 0;
    const aL = safeReadNumber(leftIds.a) || 0;

    const sR = safeReadNumber(rightIds.s) || 0;
    const cR = safeReadNumber(rightIds.c) || 0;
    const aR = safeReadNumber(rightIds.a) || 0;

    const M_total = (sL + 0.5*cL) + (sR + 0.5*cR);

    const J0_new = -0.5*cL*Math.cos(2*deg2rad(aL)) + -0.5*cR*Math.cos(2*deg2rad(aR));
    const J45_new= -0.5*cL*Math.sin(2*deg2rad(aL)) + -0.5*cR*Math.sin(2*deg2rad(aR));

    const mag = Math.hypot(J0_new,J45_new);
    const C_new_raw = -2*mag;
    const axisDefined = mag>1e-8;
    const A_new = axisDefined ? normAxis(rad2deg(0.5*Math.atan2(J45_new,J0_new))) : "-";

    const S_new_raw = M_total - 0.5*C_new_raw;

    // ROUND ONLY FINAL DISPLAY VALUES
    const S_new = roundQuarter(S_new_raw);
    const C_new = roundQuarter(C_new_raw);

    return {S_new,C_new,A_new};
}


  function crossPrescriptionsToOScrossedSpan(){
    const res = combinePair({s:"os_origS",c:"os_origC",a:"os_origA"},{s:"od_roundS",c:"od_roundC",a:"od_roundA"});
    const span = document.getElementById("OScrossedSpan");
    if(!span) return;
    span.textContent = `${fmt(res.S_new)} / ${fmt(res.C_new)} × ${res.A_new}`;
  }

  function crossPrescriptions2(){
    const res = combinePair({s:"od_origS",c:"od_origC",a:"od_origA"},{s:"os_roundS",c:"os_roundC",a:"os_roundA"});
    const span = document.getElementById("ODcrossedSpan");
    if(!span) return;
    span.textContent = `${fmt(res.S_new)} / ${fmt(res.C_new)} × ${res.A_new}`;
  }

  ["os_origS","os_origC","os_origA"].forEach(id=>{
    const el=document.getElementById(id); if(!el) return;
    el.addEventListener("input",crossPrescriptionsToOScrossedSpan);
    el.addEventListener("change",crossPrescriptionsToOScrossedSpan);
  });
  ["od_roundS","od_roundC","od_roundA"].forEach(id=>{
    const el=document.getElementById(id); if(!el) return;
    new MutationObserver(crossPrescriptionsToOScrossedSpan).observe(el,{childList:true,characterData:true,subtree:true});
  });

  ["od_origS","od_origC","od_origA"].forEach(id=>{
    const el=document.getElementById(id); if(!el) return;
    el.addEventListener("input",crossPrescriptions2);
    el.addEventListener("change",crossPrescriptions2);
  });
  ["os_roundS","os_roundC","os_roundA"].forEach(id=>{
    const el=document.getElementById(id); if(!el) return;
    new MutationObserver(crossPrescriptions2).observe(el,{childList:true,characterData:true,subtree:true});
  });

  let fallbackCount1=0;
  const fallbackInterval1=setInterval(()=>{
    crossPrescriptionsToOScrossedSpan();
    fallbackCount1++; if(fallbackCount1>8) clearInterval(fallbackInterval1);
  },150);

  let fallbackCount2=0;
  const fallbackInterval2=setInterval(()=>{
    crossPrescriptions2();
    fallbackCount2++; if(fallbackCount2>8) clearInterval(fallbackInterval2);
  },150);

  crossPrescriptionsToOScrossedSpan();
  crossPrescriptions2();

  window.crossPrescriptionsToOScrossedSpan=crossPrescriptionsToOScrossedSpan;
  window.crossPrescriptions2=crossPrescriptions2;
})();
</script>








<script>
function updateCurrentSummary() {
  const fields = [
    { id: "current_comments1", label: "" },
    { id: "current_comments2", label: "" },
    { id: "current_comments3", label: "" },
    { id: "current_comments4", label: "" },
    { id: "current_comments5", label: "" }
  ];

  const parts = [];

  fields.forEach(f => {
    const v = document.getElementById(f.id)?.value.trim();
    if (v) parts.push(v);
  });

  document.getElementById("current_comments_summary").textContent =
    parts.length ? parts.join(". ") + "." : "";
}
</script>


<script>
function updateVectorSummary() {
  const fields = [
    { id: "vector_comments1", label: "" },
    { id: "vector_comments2", label: "" },
    { id: "vector_comments3", label: "" },
    { id: "vector_comments4", label: "" },
    { id: "vector_comments5", label: "" }
  ];

  const parts = [];

  fields.forEach(f => {
    const v = document.getElementById(f.id)?.value.trim();
    if (v) parts.push(v);
  });

  document.getElementById("vector_comments_summary").textContent =
    parts.length ? parts.join(". ") + "." : "";
}
</script>


<script>
function updateManualSummary() {
  const fields = [
    { id: "manual_comments1", label: " " },
    { id: "manual_comments2", label: " " },
    { id: "manual_comments3", label: " " },
    { id: "manual_comments4", label: " " },
    { id: "manual_comments5", label: " " }
  ];

  const parts = [];

  fields.forEach(f => {
    const v = document.getElementById(f.id)?.value.trim();
    if (v) parts.push(v);
  });

  document.getElementById("manual_comments_summary").textContent =
    parts.length ? parts.join(". ") + "." : "";
}
</script>







<script>
document.getElementById("fillCurrentBtn").addEventListener("click", () => {
  // Map Vector spans to Current RX input IDs
  const mapping = [
    { span: "od_vcFinalS", input: "od_origS" },
    { span: "od_vcFinalC", input: "od_origC" },
    { span: "od_vcFinalA", input: "od_origA" },
    { span: "os_vcFinalS", input: "os_origS" },
    { span: "os_vcFinalC", input: "os_origC" },
    { span: "os_vcFinalA", input: "os_origA" }
  ];

  mapping.forEach(({span, input}) => {
    const spanEl = document.getElementById(span);
    const inputEl = document.getElementById(input);
    if (spanEl && inputEl) {
      let val = spanEl.textContent.trim();
      if (val.startsWith("+")) val = val.slice(1); // remove plus sign
      inputEl.value = val;
      inputEl.dispatchEvent(new Event('input', { bubbles: true }));
      inputEl.dispatchEvent(new Event('change', { bubbles: true }));
    }
  });

  // Clear VC inputs
  ["vc_odS","vc_odC","vc_odA","vc_osS","vc_osC","vc_osA"].forEach(id => {
    const el = document.getElementById(id);
    if (el) {
      el.value = "";
      el.dispatchEvent(new Event('input', { bubbles: true }));
      el.dispatchEvent(new Event('change', { bubbles: true }));
    }
  });
});

document.getElementById("fillCurrentBtn").addEventListener("click", () => {
  // --- existing logic ---
  
  // Highlight button after click
  const btn = document.getElementById("fillCurrentBtn");
  btn.style.backgroundColor = "#EBDADA";  // red
  btn.style.color = "black";               // text black
  btn.textContent = "Latest Vector Rx";             // change label
});

</script>










<script>
// Export inputs as CSV and open Gmail
function exportInputs() {
  const out = ["RX_EXPORT_INPUTS_V1"];

  // inputs
  document.querySelectorAll("input[id]").forEach(el => {
    out.push(`${el.id}=${el.value}`);
  });

  // statuses (buttons or selects)
["statusVector", "statusManual"].forEach(id => {
  const el = document.getElementById(id);
  if (el) {
    const value = el.tagName === "SELECT" 
                  ? el.options[el.selectedIndex].text 
                  : el.dataset.value; // button
    out.push(`${id}=${value}`);
  }
});


  ["od_vcFinalS","od_vcFinalC","od_vcFinalA","os_vcFinalS","os_vcFinalC","os_vcFinalA"].forEach(id => {
    const el = document.getElementById(id);
    if (el) out.push(`${id}=${el.textContent}`);
  });

  const csvText = out.join(", ");
  document.getElementById("rxExportBox").value = csvText;

  const separator = "--------------------------";

  const summaryText = 
`Comments Summary:
Current : ${document.getElementById("current_comments_summary")?.textContent || "-" }
Vector : ${document.getElementById("vector_comments_summary")?.textContent || "-" }
Manual : ${document.getElementById("manual_comments_summary")?.textContent || "-" }

--------------------------

CURRENT:
--> Far RX R/L:     ${document.getElementById("od_origCombined")?.textContent || "-"}     //     ${document.getElementById("os_origCombined")?.textContent || "-"}
--> Near RX R/L:     (Add ${document.getElementById("mirrorNearAdd")?.textContent || "+0.00"})     ${document.getElementById("od_nearCombined")?.textContent || "-"}     //     ${document.getElementById("os_nearCombined")?.textContent || "-"}
--> PD R/L:     ${document.getElementById("od_PD")?.value || "-"} / ${document.getElementById("os_PD")?.value || "-"}
--> NOC R/L:     ${document.getElementById("od_NOC")?.value || "-"} / ${document.getElementById("os_NOC")?.value || "-"}

Gaze Imbalance:     Horizontal: ${document.getElementById("origCrossS")?.textContent || "-"}     //     Vertical: ${document.getElementById("origCrossC")?.textContent || "-"}     //     Diagonal: ${document.getElementById("origCrossA")?.textContent || "-"}  
ADD:     ${document.getElementById("nearAdd")?.value || "0.00"} 

--------------------------

VECTOR (${
  (function(el){
    if(!el) return "-";
    return el.tagName === "SELECT"
      ? el.options[el.selectedIndex]?.text || "-"
      : el.dataset.value || "-";
  })(document.getElementById("statusVector"))
})
--> Far RX R/L:     ${document.getElementById("od_vcCombined")?.textContent || "-"}     //     ${document.getElementById("os_vcCombined")?.textContent || "-"}
--> Near RX R/L:     (Add ${document.getElementById("mirrorNearAddVector")?.textContent || "+0.00"})     ${document.getElementById("od_vcNearCombined_mirror")?.textContent || "-"}     //     ${document.getElementById("os_vcNearCombined_mirror")?.textContent || "-"}
--> CL RX R/L:     ${document.getElementById("CL_od_vcCombined")?.textContent || "-"}     //     ${document.getElementById("CL_os_vcCombined")?.textContent || "-"}
--> PD R/L:     ${document.getElementById("od_PD")?.value || "-"} / ${document.getElementById("os_PD")?.value || "-"}
--> NOC R/L:     ${document.getElementById("od_NOC")?.value || "-"} / ${document.getElementById("os_NOC")?.value || "-"}

Gaze Imbalance:     Horizontal: ${document.getElementById("prismH_vc")?.textContent || "-"}     //     Vertical  ${document.getElementById("prismV_vc")?.textContent || "-"}     //     Diagonal: ${document.getElementById("prismD_vc")?.textContent || "-"}  
ADD:     ${document.getElementById("nearAddVector")?.value || "0.00"}   
FC DC Bal Both Eye:     ${document.getElementById("vd_ouSummary")?.textContent || "-"}  
FC DC BAL R/L:     ${document.getElementById("vd_odSummary")?.textContent || "-"}     //     ${document.getElementById("vd_osSummary")?.textContent || "-"}  
RX Changes R/L:          ${document.getElementById("vc_odSummary")?.textContent || "-"}     //     ${document.getElementById("vc_osSummary")?.textContent || "-"}

--------------------------

MANUAL (${
  (function(el){
    if(!el) return "-";
    return el.tagName === "SELECT"
      ? el.options[el.selectedIndex]?.text || "-"
      : el.dataset.value || "-";
  })(document.getElementById("statusManual"))
})
--> Far RX R/L:     ${document.getElementById("od_finalCombined")?.textContent || "-"}     //     ${document.getElementById("os_finalCombined")?.textContent || "-"}
--> Near RX R/L:     (Add ${document.getElementById("mirrorNearAddFinal")?.textContent || "+0.00"})     ${document.getElementById("od_finalNearCombined_mirror")?.textContent || "-"}     //     ${document.getElementById("os_finalNearCombined_mirror")?.textContent || "-"}
--> CL RX R/L:     ${document.getElementById("CL_od_finalCombined")?.textContent || "-"}     //     ${document.getElementById("CL_os_finalCombined")?.textContent || "-"}
--> Vectorized Right Dominant R/L:     ${document.getElementById("od_vectorDisplay_mirror")?.textContent || "-"}     //     ${document.getElementById("os_vectorDisplay_mirror")?.textContent || "-"}
--> Vectorized Left Dominant R/L:     ${document.getElementById("ODcrossedSpan_mirror")?.textContent || "-"}     //     ${document.getElementById("OScrossedSpan_mirror")?.textContent || "-"}
--> PD R/L:     ${document.getElementById("od_PD")?.value || "-"} / ${document.getElementById("os_PD")?.value || "-"}
--> NOC R/L:     ${document.getElementById("od_NOC")?.value || "-"} / ${document.getElementById("os_NOC")?.value || "-"}

Gaze Imbalance:     Horizontal: ${document.getElementById("prismH")?.textContent || "-"}     //     Vertical: ${document.getElementById("prismV")?.textContent || "-"}     //     Diagonal: ${document.getElementById("prismD")?.textContent || "-"}  
ADD:     ${document.getElementById("nearAddFinal")?.value || "0.00"}
RX Changes R/L:     ${document.getElementById("od_roundCombinedDisplay")?.textContent || "-"}     //     ${document.getElementById("os_roundCombinedDisplay")?.textContent || "-"}


--------------------------
To use this data, copy everything from the top of the body and paste into any inputs in the website.

`;

  const emailBody = csvText + "\n\n" + separator + "\n\n" + summaryText;

  const customerNameInput = document.getElementById("customerName");
  const whatsappNumberInput = document.getElementById("customerWhatsapp");
  const customerName = customerNameInput?.value.trim() || "Unnamed";
  const whatsappNumber = whatsappNumberInput?.value.trim() || "";

  const recipient = "kiara.optometry.px@gmail.com";
  const subject = encodeURIComponent(`${customerName}${whatsappNumber ? " - " + whatsappNumber : ""}`);
  const body = encodeURIComponent(emailBody);

  const gmailUrl = `https://mail.google.com/mail/?view=cm&fs=1&to=${recipient}&su=${subject}&body=${body}`;
  window.open(gmailUrl, "_blank");
}

// attach all buttons with the class
document.querySelectorAll(".exportBtn").forEach(btn => {
  btn.addEventListener("click", exportInputs);
});

// Paste listener to restore inputs from CSV
document.addEventListener("paste", e => {
  const text = e.clipboardData.getData("text").trim();
  if (!text.startsWith("RX_EXPORT_INPUTS_V1")) return;

  e.preventDefault();
  const parts = text.split(",").slice(1);

  parts.forEach(part => {
    const eq = part.indexOf("=");
    if (eq === -1) return;

    const id = part.slice(0, eq).trim();
    const val = part.slice(eq + 1).trim();

    const el = document.getElementById(id);
    if (!el) return;

    if (el.tagName === "INPUT") {
      if (el.type === "number") {
        el.value = parseFloat(val) || "";
      } else {
        el.value = val;
      }
    } else if (el.tagName === "SELECT") {
      const option = Array.from(el.options).find(o => o.text === val);
      if (option) el.value = option.value;
    }

    el.dispatchEvent(new Event('input', { bubbles: true }));
    el.dispatchEvent(new Event('change', { bubbles: true }));
  });
});
</script>


<script>
const keys = ["od_PD","od_NOC","os_PD","os_NOC"];

document.addEventListener("input", e => {
  if (!keys.includes(e.target.id)) return; // only PD/NOC

  const key = e.target.id;
  document
    .querySelectorAll(`.mirror[data-mirror="${key}"]`)
    .forEach(m => m.textContent = e.target.value || "");
});
</script>





<script>
  const fields = [
    { input: 'nearAdd', span: 'mirrorNearAdd' },
    { input: 'nearAddVector', span: 'mirrorNearAddVector' },
    { input: 'nearAddFinal', span: 'mirrorNearAddFinal' }
  ];

  fields.forEach(f => {
    const inputEl = document.getElementById(f.input);
    const spanEl = document.getElementById(f.span);

    inputEl.addEventListener('input', () => {
      spanEl.innerText = inputEl.value;
    });
  });
</script>



<script>

function updateVectorized() {
  ["od","os"].forEach(eye => {
    const sEl = document.getElementById(eye + "_finalS");
    const cEl = document.getElementById(eye + "_finalC");
    const aEl = document.getElementById(eye + "_finalA");

    if (!sEl || !cEl || !aEl) return;

    // Round to nearest 0.25
    const roundQuarter = v => Math.round(v * 4) / 4;

    // Format with + / - sign
    const formatPower = v => (v >= 0 ? "+" : "") + roundQuarter(v).toFixed(2);

    const S = formatPower(parseFloat(sEl.value) || 0);
    const C = formatPower(parseFloat(cEl.value) || 0);
    const A = parseInt(aEl.value) || 0;

    document.getElementById(eye + "_vectorDisplay").textContent = `${S} / ${C} × ${A}`;
  });
}

["od_finalS","od_finalC","od_finalA","os_finalS","os_finalC","os_finalA"].forEach(id => {
  const el = document.getElementById(id);
  if (!el) return;
  el.addEventListener("input", updateVectorized);
  el.addEventListener("change", updateVectorized);
});

updateVectorized();


</script>

<script>
function updateSummaries() {
  ["od","os"].forEach(eye => {
    const s = parseFloat(document.getElementById(eye + "_origS").value) || 0;
    const c = parseFloat(document.getElementById(eye + "_origC").value) || 0;
    const a = parseInt(document.getElementById(eye + "_origA").value) || 0;

    const roundQuarter = v => Math.round(v*4)/4;
    const formatPower = v => (v>=0?"+":"") + roundQuarter(v).toFixed(2);
    const text = `${formatPower(s)} / ${formatPower(c)} × ${a}`;

    // Update all spans with the corresponding class
    document.querySelectorAll(`.${eye}_summary`).forEach(el => el.textContent = text);
  });
}

// Hook inputs to update summaries automatically
["od_origS","od_origC","od_origA","os_origS","os_origC","os_origA"].forEach(id => {
  const el = document.getElementById(id);
  el.addEventListener("input", updateSummaries);
  el.addEventListener("change", updateSummaries);
});

// Initial update
updateSummaries();
</script>



<SCRIPT>



window.addEventListener("DOMContentLoaded", () => {
  const addInput = document.getElementById("nearAddFinal");

  function updateFinalNearRx() {
    const add = parseFloat(addInput.value) || 0;

    // Get subjective Rx values
    const odS = parseFloat(document.getElementById("od_finalS").value) || 0;
    const odC = parseFloat(document.getElementById("od_finalC").value) || 0;
    const odA = parseInt(document.getElementById("od_finalA").value) || 0;

    const osS = parseFloat(document.getElementById("os_finalS").value) || 0;
    const osC = parseFloat(document.getElementById("os_finalC").value) || 0;
    const osA = parseInt(document.getElementById("os_finalA").value) || 0;

    // Near sphere = subjective Sph + Add
    let odNearS = odS + add;
    let osNearS = osS + add;

    // Format with plus sign if positive
    odNearS = (odNearS > 0 ? "+" : "") + odNearS.toFixed(2);
    osNearS = (osNearS > 0 ? "+" : "") + osNearS.toFixed(2);

    // Update spans
    document.getElementById("od_finalNearCombined").textContent = `${odNearS} / ${odC.toFixed(2)} × ${odA}`;
    document.getElementById("os_finalNearCombined").textContent = `${osNearS} / ${osC.toFixed(2)} × ${osA}`;
  }

  // Update whenever Add changes
  addInput.addEventListener("input", updateFinalNearRx);

  // Update live whenever subjective Rx changes
  ["od_finalS","od_finalC","od_finalA","os_finalS","os_finalC","os_finalA"].forEach(id => {
    const el = document.getElementById(id);
    if(el) el.addEventListener("input", updateFinalNearRx);
  });

  // Initial update
  updateFinalNearRx();
});


window.addEventListener("DOMContentLoaded", () => {
  const addInput = document.getElementById("nearAdd");

  function updateNearRx() {
    const add = parseFloat(addInput.value) || 0;

    // Get distance Rx values
    const odS = parseFloat(document.getElementById("od_origS").value) || 0;
    const odC = parseFloat(document.getElementById("od_origC").value) || 0;
    const odA = parseInt(document.getElementById("od_origA").value) || 0;

    const osS = parseFloat(document.getElementById("os_origS").value) || 0;
    const osC = parseFloat(document.getElementById("os_origC").value) || 0;
    const osA = parseInt(document.getElementById("os_origA").value) || 0;

    // Near sphere = distance Sph + Add
    let odNearS = odS + add;
    let osNearS = osS + add;

    // Format sphere with plus sign if positive
    odNearS = (odNearS > 0 ? "+" : "") + odNearS.toFixed(2);
    osNearS = (osNearS > 0 ? "+" : "") + osNearS.toFixed(2);

    // Update spans
    document.getElementById("od_nearCombined").textContent = `${odNearS} / ${odC.toFixed(2)} × ${odA}`;
    document.getElementById("os_nearCombined").textContent = `${osNearS} / ${osC.toFixed(2)} × ${osA}`;
  }

  // Update whenever Add changes
  addInput.addEventListener("input", updateNearRx);

  // Update whenever distance Rx changes
  ["od_origS","od_origC","od_origA","os_origS","os_origC","os_origA"].forEach(id => {
    const el = document.getElementById(id);
    if(el) el.addEventListener("input", updateNearRx);
  });
});


window.addEventListener("DOMContentLoaded", () => {
  const addInput = document.getElementById("nearAddVector");

  function updateVcNearRx() {
    const add = parseFloat(addInput.value) || 0;

    // Get far vector Rx values
    const odS = parseFloat(document.getElementById("od_vcFinalS").textContent) || 0;
    const odC = parseFloat(document.getElementById("od_vcFinalC").textContent) || 0;
    const odA = parseInt(document.getElementById("od_vcFinalA").textContent) || 0;

    const osS = parseFloat(document.getElementById("os_vcFinalS").textContent) || 0;
    const osC = parseFloat(document.getElementById("os_vcFinalC").textContent) || 0;
    const osA = parseInt(document.getElementById("os_vcFinalA").textContent) || 0;

    // Near sphere = far Sph + Add
    let odNearS = odS + add;
    let osNearS = osS + add;

    // Format with plus sign if positive
    odNearS = (odNearS > 0 ? "+" : "") + odNearS.toFixed(2);
    osNearS = (osNearS > 0 ? "+" : "") + osNearS.toFixed(2);

    // Update spans
    document.getElementById("od_vcNearCombined").textContent = `${odNearS} / ${odC.toFixed(2)} × ${odA}`;
    document.getElementById("os_vcNearCombined").textContent = `${osNearS} / ${osC.toFixed(2)} × ${osA}`;
  }

  // Update on Add input change
  addInput.addEventListener("input", updateVcNearRx);

  // Live update when far vector Rx changes
  ["od_vcFinalS","od_vcFinalC","od_vcFinalA","os_vcFinalS","os_vcFinalC","os_vcFinalA"].forEach(id => {
    const el = document.getElementById(id);
    if(el) {
      // Observe textContent changes for live update
      const observer = new MutationObserver(updateVcNearRx);
      observer.observe(el, { characterData: true, childList: true, subtree: true });
    }
  });

  // Initial update
  updateVcNearRx();
});






function fmtAxis(a){
  if(a === 0 || a === "0") return 180;
  return a;
}


function calcVD(side) {
  const S = Number(document.getElementById(`vd_${side}S`).value) || 0;
  const C = Number(document.getElementById(`vd_${side}C`).value) || 0;
  const A = Number(document.getElementById(`vd_${side}A`).value) || 0;

  const sphAdj = -(C / 2);
  const outS = S + sphAdj;
  const outC = C;
  const outA = A;

  const fmt = v => (v > 0 ? "+" : "") + v.toFixed(2);

  document.getElementById(`vd_out_${side}S`).textContent = fmt(outS);
  document.getElementById(`vd_out_${side}C`).textContent = fmt(outC);
  document.getElementById(`vd_out_${side}A`).textContent = outA;
}


["od","os","ou"].forEach(side => {
  ["S","C","A"].forEach(f => {
    const el = document.getElementById(`vd_${side}${f}`);
    if(el) el.addEventListener("input", () => calcVD(side));
  });
});

</script>



<script>
/* ===== Utilities ===== */
function deg2rad(d){ return d * Math.PI / 180; }
function rad2deg(r){ return r * 180 / Math.PI; }

function normalizeMinus(lens){
  let S = Number(lens.S), C = Number(lens.C), A = Number(lens.A);
  if (isNaN(S)) S = 0; if (isNaN(C)) C = 0; if (isNaN(A)) A = 0;
  if (C > 0){ S += C; C = -C; A = (A + 90) % 180; }
  A = ((A % 180) + 180) % 180;
  return { S: +S, C: +C, A: Math.round(A) % 180 };
}
function toFixed2Num(v){ return +Number(v).toFixed(2); }
function minusToPlus(lens){
  const m = normalizeMinus(lens);
  return { S: toFixed2Num(m.S + m.C), C: toFixed2Num(-m.C), A: Math.round((m.A + 90) % 180) };
}
function roundQuarter(v){
  if(isNaN(v)) return "-";
  const r = Math.round(v / 0.25) * 0.25;
  return (r > 0 ? "+" : "") + r.toFixed(2);
}

function fmtPlus(v){
  const n = Number(v);
  if (isNaN(n)) return "-";
  return (n > 0 ? "+" : "") + n.toFixed(2);
}


function calcDecentration(angleDeg, vertexMM){ return (vertexMM / 10) * Math.tan(angleDeg * Math.PI/180); }

/* ===== Vector & lens math (unchanged) ===== */
function calcBackwardsLens(orig, final){
  const rx1 = normalizeMinus(orig), rxF = normalizeMinus(final);
  const M1 = rx1.S + rx1.C/2;
  const J01 = -rx1.C/2 * Math.cos(2 * deg2rad(rx1.A));
  const J451 = -rx1.C/2 * Math.sin(2 * deg2rad(rx1.A));
  const MF = rxF.S + rxF.C/2;
  const J0F = -rxF.C/2 * Math.cos(2 * deg2rad(rxF.A));
  const J45F = -rxF.C/2 * Math.sin(2 * deg2rad(rxF.A));
  const Mx = MF - M1;
  const J0x = J0F - J01;
  const J45x = J45F - J451;
  const Cx = -2 * Math.sqrt(J0x*J0x + J45x*J45x);
  const Sx = Mx - Cx/2;
  let Ax = 0.5 * rad2deg(Math.atan2(J45x, J0x)); if (Ax < 0) Ax += 180;
  return { S: toFixed2Num(Sx), C: toFixed2Num(Cx), A: Math.round(Ax) % 180 };
}
function pickClosestSphere(candidates){
  const normalized = candidates.map(c => normalizeMinus(c));
  let best = normalized[0];
  for(const c of normalized){ if(Math.abs(c.S) < Math.abs(best.S)) best = c; }
  best.S = toFixed2Num(best.S); best.C = toFixed2Num(best.C); best.A = Math.round(best.A) % 180;
  return best;
}
function bestSingleLens(lens){
  const form1 = { S: lens.S, C: lens.C, A: lens.A };
  const form2 = { S: lens.S + lens.C, C: -lens.C, A: (lens.A + 90) % 180 };
  return pickClosestSphere([form1, form2]);
}
function chooseBestDiff(diff1, diff2){
  const forms = l => [{S:l.S,C:l.C,A:l.A},{S:l.S+l.C,C:-l.C,A:(l.A+90)%180}];
  return pickClosestSphere([...forms(diff1), ...forms(diff2)]);
}
function reverseVectorChange(orig, vector){
  const rxOrig = normalizeMinus(orig), rxVec = normalizeMinus(vector);
  const M1 = rxOrig.S + rxOrig.C/2;
  const J01 = -rxOrig.C/2 * Math.cos(2*deg2rad(rxOrig.A));
  const J451 = -rxOrig.C/2 * Math.sin(2*deg2rad(rxOrig.A));
  const Mx = rxVec.S + rxVec.C/2;
  const J0x = -rxVec.C/2 * Math.cos(2*deg2rad(rxVec.A));
  const J45x = -rxVec.C/2 * Math.sin(2*deg2rad(rxVec.A));
  const MF = M1 + Mx;
  const J0F = J01 + J0x;
  const J45F = J451 + J45x;
  const CF = -2 * Math.sqrt(J0F*J0F + J45F*J45F);
  const SF = MF - CF/2;
  let AF = 0.5 * rad2deg(Math.atan2(J45F, J0F)); if (AF < 0) AF += 180;
  return bestSingleLens({ S: toFixed2Num(SF), C: toFixed2Num(CF), A: Math.round(AF) % 180 });
}

/* ===== Prism color helper, type-specific (percentage-based) ===== */
function colorPrism(el, value, type){
  if(!el) return;

// thresholds for percentage (adjustable)
const thresholds = {
  H: [0.3, 0.5],
  V: [0.1, 0.2],
  D: [0.15, 0.3]
};

// get original prism value
let origId;
if(type === "H") origId = "origCrossS";
else if(type === "V") origId = "origCrossC";
else if(type === "D") origId = "origCrossA";

const origText = document.getElementById(origId)?.textContent || "0";
const origVal = Number(origText) || 0;
const newVal  = Number(value) || 0;

// ===== SPECIAL ZERO RULE =====
if (origVal === 0) {
  if (newVal === 0) {
    el.style.color = "green";  // 0 ÷ 0
    return;
  } else {
    el.style.color = "red";    // anything ÷ 0
    return;
  }
}

// ===== STANDARD PERCENTAGE LOGIC =====
let pct = Math.abs(newVal) / Math.abs(origVal);

// force >100% to red
if (pct > 1) pct = 999;

// assign color
if (pct <= thresholds[type][0]) el.style.color = "green";
else if (pct <= thresholds[type][1]) el.style.color = "purple";
else el.style.color = "red";
}



/* ===== Main update function (integrated, robust) ===== */
function updateCrossedLens(){
  // read inputs (safe fallback 0)
  const odOrig = { S:+document.getElementById('od_origS')?.value || 0, C:+document.getElementById('od_origC')?.value || 0, A:+document.getElementById('od_origA')?.value || 0 };
  const odFinal = { S:+document.getElementById('od_finalS')?.value || 0, C:+document.getElementById('od_finalC')?.value || 0, A:+document.getElementById('od_finalA')?.value || 0 };
  const osOrig = { S:+document.getElementById('os_origS')?.value || 0, C:+document.getElementById('os_origC')?.value || 0, A:+document.getElementById('os_origA')?.value || 0 };
  const osFinal = { S:+document.getElementById('os_finalS')?.value || 0, C:+document.getElementById('os_finalC')?.value || 0, A:+document.getElementById('os_finalA')?.value || 0 };

  // cross calculations (same as before)
  const odCross = bestSingleLens(calcBackwardsLens(odOrig, odFinal));
  const odPlus = minusToPlus(odCross);
  const osCross = bestSingleLens(calcBackwardsLens(osOrig, osFinal));
  const osPlus = minusToPlus(osCross);

  // safe element writes (only if elements exist)
  const setIf = (id, val)=> { const el = document.getElementById(id); if(el) el.textContent = val; };
  setIf('od_crossS', roundQuarter(odCross.S));
  setIf('od_crossC', roundQuarter(odCross.C));
setIf('od_crossA', fmtAxis(odCross.A));
  setIf('od_roundS', roundQuarter(odPlus.S));
  setIf('od_roundC', roundQuarter(odPlus.C));
setIf('od_roundA', fmtAxis(odPlus.A));

setIf('os_crossS', roundQuarter(osCross.S));
  setIf('os_crossC', roundQuarter(osCross.C));
setIf('os_crossA', fmtAxis(osCross.A));
  setIf('os_roundS', roundQuarter(osPlus.S));
  setIf('os_roundC', roundQuarter(osPlus.C));
setIf('os_roundA', fmtAxis(osPlus.A));

  const bestDiff = chooseBestDiff(calcBackwardsLens(osCross, odCross), calcBackwardsLens(odCross, osCross));
  const bestDiffPlus = minusToPlus(bestDiff);

  setIf('diffCrossS', roundQuarter(bestDiffPlus.S));
  setIf('diffCrossC', roundQuarter(bestDiffPlus.C));
setIf('diffCrossA', fmtAxis(bestDiffPlus.A));

// Read diffCross spans
const diffS_text = document.getElementById("diffCrossS")?.textContent;
const diffC_text = document.getElementById("diffCrossC")?.textContent;
const diffA_text = document.getElementById("diffCrossA")?.textContent;

// Parse diffCross values
const diffS = Number.parseFloat(diffS_text) || 0;
const diffC = Number.parseFloat(diffC_text) || 0;
const diffA = Number.parseFloat(diffA_text) || 0;

// Vector calculations (diffCross format)
const A_diff_rad = deg2rad(diffA);
const M_diff = diffS + diffC / 2;
const J0_diff = -diffC / 2 * Math.cos(2 * A_diff_rad);
const J45_diff = -diffC / 2 * Math.sin(2 * A_diff_rad);

// Decentration
const gaze = Number(document.getElementById("gazeAngle")?.value) || 30;
const vertex = Number(document.getElementById("vertexDist")?.value) || 14;
const dec = calcDecentration(gaze, vertex);

// Prism calculations (diffCross using dec)
const prismH = Math.abs((M_diff + J0_diff) * dec);
const prismV = Math.abs((M_diff - J0_diff) * dec);
const prism45 = Math.abs((M_diff - J45_diff) * dec);
const prism135 = Math.abs((M_diff + J45_diff) * dec);
const prismD = Math.max(prism45, prism135);




  // write and color main prism outputs
  const elH = document.getElementById("prismH");
  const elV = document.getElementById("prismV");
  const elD = document.getElementById("prismD");
  if(elH){ elH.textContent = prismH.toFixed(2); colorPrism(elH, prismH, "H"); }
  if(elV){ elV.textContent = prismV.toFixed(2); colorPrism(elV, prismV, "V"); }
  if(elD){ elD.textContent = prismD.toFixed(2); colorPrism(elD, prismD, "D"); }

  // VC prism section (if vc_cross elements exist we parse them safely)
  const vc_crossS_text = document.getElementById("vc_crossS")?.textContent;
  const vc_crossC_text = document.getElementById("vc_crossC")?.textContent;
  const vc_crossA_text = document.getElementById("vc_crossA")?.textContent;


  // parseFloat returns NaN for "-", fallback to 0
  const vcS = Number.parseFloat(vc_crossS_text) || 0;
  const vcC = Number.parseFloat(vc_crossC_text) || 0;
  const vcA = Number.parseFloat(vc_crossA_text) || 0;
  const A_vc_rad = deg2rad(vcA);
  const M_vc = vcS + vcC/2;
  const J0_vc = -vcC/2 * Math.cos(2 * A_vc_rad);
  const J45_vc = -vcC/2 * Math.sin(2 * A_vc_rad);
  const prismH_vc = Math.abs((M_vc + J0_vc) * dec);
  const prismV_vc = Math.abs((M_vc - J0_vc) * dec);
  const prism45_vc = Math.abs((M_vc - J45_vc) * dec);
  const prism135_vc = Math.abs((M_vc + J45_vc) * dec);
  const prismD_vc = Math.max(prism45_vc, prism135_vc);

  const elH_vc = document.getElementById("prismH_vc");
  const elV_vc = document.getElementById("prismV_vc");
  const elD_vc = document.getElementById("prismD_vc");
  if(elH_vc){ elH_vc.textContent = prismH_vc.toFixed(2); colorPrism(elH_vc, prismH_vc, "H"); }
  if(elV_vc){ elV_vc.textContent = prismV_vc.toFixed(2); colorPrism(elV_vc, prismV_vc, "V"); }
  if(elD_vc){ elD_vc.textContent = prismD_vc.toFixed(2); colorPrism(elD_vc, prismD_vc, "D"); }
}

/* ===== Reverse vector -> final (keeps existing behavior) ===== */
function updateFinalFromVector(){
  const origOD = { S:+document.getElementById('od_origS')?.value || 0, C:+document.getElementById('od_origC')?.value || 0, A:+document.getElementById('od_origA')?.value || 0 };
  const origOS = { S:+document.getElementById('os_origS')?.value || 0, C:+document.getElementById('os_origC')?.value || 0, A:+document.getElementById('os_origA')?.value || 0 };
  const vcOD = { S:+document.getElementById('vc_odS')?.value || 0, C:+document.getElementById('vc_odC')?.value || 0, A:+document.getElementById('vc_odA')?.value || 0 };
  const vcOS = { S:+document.getElementById('vc_osS')?.value || 0, C:+document.getElementById('vc_osC')?.value || 0, A:+document.getElementById('vc_osA')?.value || 0 };

  const finalOD = reverseVectorChange(origOD, vcOD);
  const finalOS = reverseVectorChange(origOS, vcOS);

  const setIf = (id, val)=> { const el = document.getElementById(id); if(el) el.textContent = val; };
  setIf('od_vcFinalS', roundQuarter(finalOD.S));
  setIf('od_vcFinalC', roundQuarter(finalOD.C));
setIf('od_vcFinalA', fmtAxis(finalOD.A));

  setIf('os_vcFinalS', roundQuarter(finalOS.S));
  setIf('os_vcFinalC', roundQuarter(finalOS.C));
setIf('os_vcFinalA', fmtAxis(finalOS.A));

  const bestVCCross = chooseBestDiff(calcBackwardsLens(vcOS, vcOD), calcBackwardsLens(vcOD, vcOS));
  const bestVCCrossPlus = minusToPlus(bestVCCross);
  setIf('vc_crossS', roundQuarter(bestVCCrossPlus.S));
  setIf('vc_crossC', roundQuarter(bestVCCrossPlus.C));
setIf('vc_crossA', fmtAxis(bestVCCrossPlus.A));

  updateCrossedLens();
}



/* ===== Listeners attach after DOM ready ===== */
window.addEventListener("DOMContentLoaded", ()=>{
  // attach vector listeners (if elements exist)
  ['vc_odS','vc_odC','vc_odA','vc_osS','vc_osC','vc_osA','vc_ouS', 'vc_ouC','vc_ouA'].forEach(id=>{
    const el = document.getElementById(id);
    if(el) el.addEventListener('input', updateFinalFromVector);
  });



  // input list for general updates
  document.querySelectorAll("input").forEach(i=>{
    i.addEventListener('input', updateCrossedLens);
    // keep sphere/cyl input coloring (existing behavior)
    const id = i.id;
 const colorInputs = [
  'od_origS', 'od_origC', 'os_origS', 'os_origC',
  'od_finalS', 'od_finalC', 'os_finalS', 'os_finalC',
  'vc_odS', 'vc_odC', 'vc_osS', 'vc_osC', 'vc_ouS', 'vc_ouC',
  'vd_odS', 'vd_odC', 'vd_osS', 'vd_osC', 'vd_ouS', 'vd_ouC',
  'vd_out_odS', 'vd_out_odC', 'vd_out_osS', 'vd_out_osC', 'vd_out_ouS', 'vd_out_ouC',
  // new Problem inputs
  'od_rectS', 'od_rectC',  
  'os_rectS', 'os_rectC',
  'cl-sph-re','cl-cyl-re','cl-sph-le','cl-cyl-le',
 'nearAddVector','nearAddFinal','nearAdd','TS_sph','TS_cyl'
  
];


;

    if(colorInputs.includes(id)){
      const colorUpdate = ()=> {
        const val = parseFloat(i.value);
        if (!isNaN(val)) i.style.color = (val > 0 ? "green" : (val < 0 ? "red" : "black"));
        else i.style.color = "black";
      };
      i.addEventListener('input', colorUpdate);
      i.addEventListener('blur', ()=>{ const val = parseFloat(i.value); if(!isNaN(val)) i.value = (Math.round(val / 0.25) * 0.25).toFixed(2); colorUpdate(); });
      colorUpdate();
    }
  });

  // initial run
  updateCrossedLens();



});
function fireInputEvents(ids) {
  ids.forEach(id => {
    const el = document.getElementById(id);
    if (!el) return;
    el.dispatchEvent(new Event('input', { bubbles: true }));
    el.dispatchEvent(new Event('change', { bubbles: true }));
  });
}



function copyVD_OU() {
  const s = Number(document.getElementById("vd_out_ouS").textContent);
  const c = Number(document.getElementById("vd_out_ouC").textContent);
  const a = Number(document.getElementById("vd_out_ouA").textContent);

  document.getElementById("vc_ouS").value = s;
  document.getElementById("vc_ouC").value = c;
  document.getElementById("vc_ouA").value = a;

  fireInputEvents(["vc_ouS", "vc_ouC", "vc_ouA"]);

  if (typeof updateFinalFromVector === "function") updateFinalFromVector();
}

function copyVD_OD() {
  const s = Number(document.getElementById("vd_out_odS").textContent);
  const c = Number(document.getElementById("vd_out_odC").textContent);
  const a = Number(document.getElementById("vd_out_odA").textContent);

  document.getElementById("vc_odS").value = s;
  document.getElementById("vc_odC").value = c;
  document.getElementById("vc_odA").value = a;

  fireInputEvents(["vc_odS", "vc_odC", "vc_odA"]);

  if (typeof updateFinalFromVector === "function") updateFinalFromVector();
}

function copyVD_OS() {
  const s = Number(document.getElementById("vd_out_osS").textContent);
  const c = Number(document.getElementById("vd_out_osC").textContent);
  const a = Number(document.getElementById("vd_out_osA").textContent);

  document.getElementById("vc_osS").value = s;
  document.getElementById("vc_osC").value = c;
  document.getElementById("vc_osA").value = a;

  fireInputEvents(["vc_osS", "vc_osC", "vc_osA"]);

  if (typeof updateFinalFromVector === "function") updateFinalFromVector();
}


</script>


<script>
// Format sphere/cylinder: add + for positive, 2 decimals
function fmtPlus(v){
  const n = Number(v);
  if(isNaN(n)) return "-";
  return (n > 0 ? "+" : "") + n.toFixed(2);
}

// Format axis: just round and wrap 0-179, no + sign
function fmtAxis(a){
  const n = Number(a);
  if(isNaN(n)) return "-";
  return Math.round(n) % 180;
}

function updateVDVCSummary() {
  const vdOD = "DC " + fmtPlus(document.getElementById("vd_odS").value) + 
               " ; FC " + fmtPlus(document.getElementById("vd_odC").value) + 
               " × " + fmtAxis(document.getElementById("vd_odA").value);

  const vdOS = "DC " + fmtPlus(document.getElementById("vd_osS").value) + 
               " ; FC " + fmtPlus(document.getElementById("vd_osC").value) + 
               " × " + fmtAxis(document.getElementById("vd_osA").value);

  const vcOD = fmtPlus(document.getElementById("vc_odS").value) + 
               " / " + fmtPlus(document.getElementById("vc_odC").value) + 
               " × " + fmtAxis(document.getElementById("vc_odA").value);

  const vcOS = fmtPlus(document.getElementById("vc_osS").value) + 
               " / " + fmtPlus(document.getElementById("vc_osC").value) + 
               " × " + fmtAxis(document.getElementById("vc_osA").value);

  document.getElementById("vd_odSummary").textContent = vdOD;
  document.getElementById("vd_osSummary").textContent = vdOS;
  document.getElementById("vc_odSummary").textContent = vcOD;
  document.getElementById("vc_osSummary").textContent = vcOS;
}


// Attach to inputs
["vd_odS","vd_odC","vd_odA",
 "vd_osS","vd_osC","vd_osA",
 "vc_odS","vc_odC","vc_odA",
 "vc_osS","vc_osC","vc_osA",]

.forEach(id => {
  const el = document.getElementById(id);
  if(el) el.addEventListener("input", updateVDVCSummary);
});

// Initial update
updateVDVCSummary();


function updateVDVCOUSummary() {
  const vdOU = "DC " + fmtPlus(document.getElementById("vd_ouS").textContent) +
               " ; FC " + fmtPlus(document.getElementById("vd_ouC").textContent) +
               " × " + fmtAxis(document.getElementById("vd_ouA").textContent);

  const vcOU = fmtPlus(document.getElementById("vc_ouS").value) +
               " / " + fmtPlus(document.getElementById("vc_ouC").value) +
               " × " + fmtAxis(document.getElementById("vc_ouA").value);

  const vdEl = document.getElementById("vd_ouSummary");
  if(vdEl) vdEl.textContent = vdOU;

  const vcEl = document.getElementById("vc_ouSummary");
  if(vcEl) vcEl.textContent = vcOU;
}


// Attach to OU inputs
["vd_ouS","vd_ouC","vd_ouA",
 "vc_ouS","vc_ouC","vc_ouA"].forEach(id => {
   const el = document.getElementById(id);
   if(el) el.addEventListener("input", updateVDVCOUSummary);
});

// Initial update
updateVDVCOUSummary();



</script>















<script>
(function(){
  // small helpers (safe, unique names)
  function _parseSpanNumber(txt){
    if(!txt && txt !== 0) return NaN;
    // remove any non-number except - and .
    const cleaned = String(txt).replace(/\+/g,'').replace(/[^\d\.\-]/g,'').trim();
    return cleaned === '' ? NaN : parseFloat(cleaned);
  }

  function _fmtPlus(n){
    if (isNaN(n)) return "-";
    return (n > 0 ? "+" : "") + Number(n).toFixed(2);
  }

  // === Copy functions (global for onclick) ===




window.copyVD_OU = function(){
    const sText = document.getElementById("vd_out_ouS")?.textContent || "";
    const cText = document.getElementById("vd_out_ouC")?.textContent || "";
    const aText = document.getElementById("vd_out_ouA")?.textContent || "";

    const s = _parseSpanNumber(sText);
    const c = _parseSpanNumber(cText);
    const a = _parseSpanNumber(aText);

    if(!isNaN(s) && document.getElementById("vc_ouS")) document.getElementById("vc_ouS").value = s.toFixed(2);
    if(!isNaN(c) && document.getElementById("vc_ouC")) document.getElementById("vc_ouC").value = c.toFixed(2);
    if(!isNaN(a) && document.getElementById("vc_ouA")) document.getElementById("vc_ouA").value = (isNaN(a)?'':a);

    if(typeof updateFinalFromVector === "function") updateFinalFromVector();
};


  window.copyVD_OD = function(){
    const sText = document.getElementById("vd_out_odS")?.textContent || "";
    const cText = document.getElementById("vd_out_odC")?.textContent || "";
    const aText = document.getElementById("vd_out_odA")?.textContent || "";

    const s = _parseSpanNumber(sText);
    const c = _parseSpanNumber(cText);
    const a = _parseSpanNumber(aText);

    if(!isNaN(s) && document.getElementById("vc_odS")) document.getElementById("vc_odS").value = s.toFixed(2);
    if(!isNaN(c) && document.getElementById("vc_odC")) document.getElementById("vc_odC").value = c.toFixed(2);
    if(!isNaN(a) && document.getElementById("vc_odA")) document.getElementById("vc_odA").value = (isNaN(a)?'':a);

    if(typeof updateFinalFromVector === "function") updateFinalFromVector();
  };

  window.copyVD_OS = function(){
    const sText = document.getElementById("vd_out_osS")?.textContent || "";
    const cText = document.getElementById("vd_out_osC")?.textContent || "";
    const aText = document.getElementById("vd_out_osA")?.textContent || "";

    const s = _parseSpanNumber(sText);
    const c = _parseSpanNumber(cText);
    const a = _parseSpanNumber(aText);

    if(!isNaN(s) && document.getElementById("vc_osS")) document.getElementById("vc_osS").value = s.toFixed(2);
    if(!isNaN(c) && document.getElementById("vc_osC")) document.getElementById("vc_osC").value = c.toFixed(2);
    if(!isNaN(a) && document.getElementById("vc_osA")) document.getElementById("vc_osA").value = (isNaN(a)?'':a);

    if(typeof updateFinalFromVector === "function") updateFinalFromVector();
  };



// ===== Helper functions =====
function _parseSpanNumber(text){
  const n = parseFloat(text.replace(/[^\d.-]/g,""));
  return isNaN(n) ? NaN : n;
}
function fmtPlus(n){ return isNaN(n) ? "-" : (n>0?"+":"")+n.toFixed(2); }
function fmtAxis(a){ return isNaN(a) ? "-" : Math.round(a)%180; }

// ===== Copy VD to VC and update summary =====
function copyVD(eye){
  const sText = document.getElementById(`vd_out_${eye}S`)?.textContent || "";
  const cText = document.getElementById(`vd_out_${eye}C`)?.textContent || "";
  const aText = document.getElementById(`vd_out_${eye}A`)?.textContent || "";

  const s = _parseSpanNumber(sText);
  const c = _parseSpanNumber(cText);
  const a = _parseSpanNumber(aText);

  const vcS = document.getElementById(`vc_${eye}S`);
  const vcC = document.getElementById(`vc_${eye}C`);
  const vcA = document.getElementById(`vc_${eye}A`);

  if(!isNaN(s) && vcS) vcS.value = s.toFixed(2);
  if(!isNaN(c) && vcC) vcC.value = c.toFixed(2);
  if(!isNaN(a) && vcA) vcA.value = a;

  // Dispatch input/change so downstream formulas run
  [vcS, vcC, vcA].forEach(el=>{
    if(el){
      el.dispatchEvent(new Event("input",{bubbles:true}));
      el.dispatchEvent(new Event("change",{bubbles:true}));
    }
  });

  // Update final vector calculation
  if(typeof updateFinalFromVector === "function") updateFinalFromVector();

  updateCombinedRound(); // existing combined display updater
}





function copyVD_OU_to_ODOS() {
  const get = id => document.getElementById(id);
  
  // Read input values (not spans)
  const s = parseFloat(get("vd_ouS")?.value) || 0;
  const c = parseFloat(get("vd_ouC")?.value) || 0;
  const a = parseFloat(get("vd_ouA")?.value) || 0;

  // Copy to OD
  ["od","os"].forEach(eye => {
    const vcS = get(`vc_${eye}S`);
    const vcC = get(`vc_${eye}C`);
    const vcA = get(`vc_${eye}A`);
    if(vcS) vcS.value = s.toFixed(2);
    if(vcC) vcC.value = c.toFixed(2);
    if(vcA) vcA.value = a;
    
    // Fire events so listeners update
    [vcS, vcC, vcA].forEach(el => {
      if(el){
        el.dispatchEvent(new Event("input",{bubbles:true}));
        el.dispatchEvent(new Event("change",{bubbles:true}));
      }
    });
  });

  // Update final vector display if function exists
  if(typeof updateFinalFromVector === "function") updateFinalFromVector();

  // Update OU summary display
  const vdOU = "DC " + fmtPlus(s) + " ; FC " + fmtPlus(c) + " × " + fmtAxis(a);
  const vcOU = fmtPlus(s) + " / " + fmtPlus(c) + " × " + fmtAxis(a);
  if(get("vd_ouSummary")) get("vd_ouSummary").textContent = vdOU;
  if(get("vc_ouSummary")) get("vc_ouSummary").textContent = vcOU;
}



window.copyVD_OU = ()=>copyVD("ou");
window.copyVD_OD = ()=>copyVD("od");
window.copyVD_OS = ()=>copyVD("os");




// ===== Combined display updater =====
function updateCombinedRound(){
  ["od","os"].forEach(eye=>{
    const S = document.getElementById(`${eye}_roundS`)?.textContent || "-";
    const C = document.getElementById(`${eye}_roundC`)?.textContent || "-";
    const A = document.getElementById(`${eye}_roundA`)?.textContent || "-";
    const el = document.getElementById(`${eye}_roundCombinedDisplay`);
    if(el) el.textContent = `${S} / ${C} × ${A}`;
  });
}

// ===== Observe changes =====
["od_roundS","od_roundC","od_roundA","os_roundS","os_roundC","os_roundA"].forEach(id=>{
  const el = document.getElementById(id);
  if(!el) return;
  new MutationObserver(updateCombinedRound).observe(el, { childList:true, characterData:true, subtree:true });
});

// Initial update
updateCombinedRound();








  // === Combined display updaters ===
  function updateCombinedVC(){
    const odS = document.getElementById("od_vcFinalS")?.textContent || "-";
    const odC = document.getElementById("od_vcFinalC")?.textContent || "-";
    const odA = document.getElementById("od_vcFinalA")?.textContent || "-";
    const osS = document.getElementById("os_vcFinalS")?.textContent || "-";
    const osC = document.getElementById("os_vcFinalC")?.textContent || "-";
    const osA = document.getElementById("os_vcFinalA")?.textContent || "-";

    const odCombEl = document.getElementById("od_vcCombined");
    const osCombEl = document.getElementById("os_vcCombined");
    if(odCombEl) odCombEl.textContent = `${odS} / ${odC} × ${odA}`;
    if(osCombEl) osCombEl.textContent = `${osS} / ${osC} × ${osA}`;
  }

function fmtPlus(v){
  const n = Number(v);
  if(isNaN(n)) return "-";
  return (n > 0 ? "+" : "") + n.toFixed(2);
}

function fmtAxis(a){
  const n = Number(a);
  if(isNaN(n)) return "-";
  return Math.round(n) % 180;
}

function updateCombinedOriginal(){
  const odS = document.getElementById("od_origS")?.value;
  const odC = document.getElementById("od_origC")?.value;
  const odA = document.getElementById("od_origA")?.value;

  const osS = document.getElementById("os_origS")?.value;
  const osC = document.getElementById("os_origC")?.value;
  const osA = document.getElementById("os_origA")?.value;

  const odEl = document.getElementById("od_origCombined");
  const osEl = document.getElementById("os_origCombined");

  if(odEl) odEl.textContent = `${fmtPlus(odS)} / ${fmtPlus(odC)} × ${fmtAxis(odA)}`;
  if(osEl) osEl.textContent = `${fmtPlus(osS)} / ${fmtPlus(osC)} × ${fmtAxis(osA)}`;
}

// auto-update when inputs change
["od_origS","od_origC","od_origA","os_origS","os_origC","os_origA"].forEach(id=>{
  const el = document.getElementById(id);
  if(el) el.addEventListener("input", updateCombinedOriginal);
});

// initial run
updateCombinedOriginal();

  function updateCombinedFinal(){
    const odS = document.getElementById("od_finalS")?.value;
    const odC = document.getElementById("od_finalC")?.value;
    const odA = document.getElementById("od_finalA")?.value;
    const osS = document.getElementById("os_finalS")?.value;
    const osC = document.getElementById("os_finalC")?.value;
    const osA = document.getElementById("os_finalA")?.value;

    const odCombEl = document.getElementById("od_finalCombined");
    const osCombEl = document.getElementById("os_finalCombined");

    if(odCombEl) odCombEl.textContent = `${_fmtPlus(Number(odS))} / ${_fmtPlus(Number(odC))} × ${odA || "-"}`;
    if(osCombEl) osCombEl.textContent = `${_fmtPlus(Number(osS))} / ${_fmtPlus(Number(osC))} × ${osA || "-"}`;
  }

  // === Observe updates to vcFinal spans (they are updated by your code) ===
  function _observeIfExists(selectorList, cb){
    selectorList.forEach(id=>{
      const el = document.getElementById(id);
      if(!el) return;
      const mo = new MutationObserver(cb);
      mo.observe(el, { childList: true, characterData: true, subtree: true });
    });
  }

  // Attach when DOM ready
  window.addEventListener("DOMContentLoaded", ()=>{
    // observe vcFinal spans so combined VC updates when updateFinalFromVector writes to them
    _observeIfExists(["od_vcFinalS","od_vcFinalC","od_vcFinalA","os_vcFinalS","os_vcFinalC","os_vcFinalA"], updateCombinedVC);
    // initial run
    updateCombinedVC();

    // attach listeners to manual final inputs so combined final updates immediately
    ["od_finalS","od_finalC","od_finalA","os_finalS","os_finalC","os_finalA"].forEach(id=>{
      const el = document.getElementById(id);
      if(el) el.addEventListener("input", updateCombinedFinal);
    });
    updateCombinedFinal();

    // also observe vd_out spans if they exist — keep them normalized (no destructive edits)
    // (This does not change original behaviour; only ensures numbers are parseable when copying)
    _observeIfExists(["vd_out_odS","vd_out_odC","vd_out_odA",
 "vd_out_osS","vd_out_osC","vd_out_osA",
 "vd_out_ouS","vd_out_ouC","vd_out_ouA"]
, 

function(){
      // noop: observation kept in place to ensure future expansions possible; we call nothing here
    });
  });

  // Expose safe helpers for debugging if needed
  window._vdHelpers = { parseSpanNumber: _parseSpanNumber, fmtPlus: _fmtPlus, updateCombinedVC, updateCombinedFinal };

})();

// attach listeners
['od_origS','od_origC','od_origA','os_origS','os_origC','os_origA'].forEach(id=>{
  const el = document.getElementById(id);
  if(el) el.addEventListener('input', updateOriginalPrism);
});

// initial run
updateOriginalPrism();

</script>





<script>


document.querySelectorAll(".toggleMask2").forEach(btn => {
  btn.addEventListener("click", function () {
    document.querySelectorAll(".mask2").forEach(row => {
      row.classList.toggle("hidden-row");
    });
  });
});

document.querySelectorAll(".toggleMask3").forEach(btn => {
  btn.addEventListener("click", function () {
    document.querySelectorAll(".mask3").forEach(row => {
      row.classList.toggle("hidden-row");
    });
  });
});

document.querySelectorAll(".toggleMask4").forEach(btn => {
  btn.addEventListener("click", function () {
    document.querySelectorAll(".mask4").forEach(row => {
      row.classList.toggle("hidden-row");
    });
  });
});

</script>



<script>
function toggleManualMask1() {
  document.querySelectorAll(".mask1").forEach(row => row.classList.toggle("hidden-row"));
}

// Attach the same function to both buttons
document.getElementById("toggleMask1").addEventListener("click", toggleManualMask1);
document.getElementById("toggleMask1_copy").addEventListener("click", toggleManualMask1);
</script>



<script>
function sendWhatsapp() {
  const number = document.getElementById("customerWhatsapp").value.trim().replace(/\D/g,'');
  const name = document.getElementById("customerName").value.trim();
  const notes = document.getElementById("notes").value.trim();

  if(!number) return;

  const msg = `Greetings ${name} from Kiara Optometry! ${notes}`;
  window.open(`https://wa.me/${number}?text=${encodeURIComponent(msg)}`, "_blank");
}

document.getElementById("sendWhatsappBtn").addEventListener("click", sendWhatsapp);
</script>

<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>

<script>
function capturePart() {
  const target = document.getElementById("captureTarget");

  html2canvas(target).then(fullCanvas => {

    const borderSize = 20; // size of white border in pixels

    const w = fullCanvas.width + borderSize * 2;
    const h = fullCanvas.height + borderSize * 2;

    const cropped = document.createElement("canvas");
    cropped.width = w;
    cropped.height = h;

    const ctx = cropped.getContext("2d");

    // fill background with white
    ctx.fillStyle = "#ffffff";
    ctx.fillRect(0, 0, w, h);

    // draw the captured content in the center
    ctx.drawImage(fullCanvas, borderSize, borderSize);

    // save JPG with customer name and current date
    const link = document.createElement("a");
    const name = document.getElementById("customerName")?.value || "Unnamed";
    const now = new Date();
    const day = String(now.getDate()).padStart(2, '0');
    const monthNames = ["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];
    const month = monthNames[now.getMonth()];
    const year = now.getFullYear();
    const today = `${day}-${month}-${year}`;
    link.download = `${name}_${today}.jpg`;
    link.href = cropped.toDataURL("image/jpeg", 0.9);
    link.click();
});

}
</script>


<script>
(function(){
  const get = id => document.getElementById(id);

  // --- OU Summary Updater (reads final OU spans) ---
  function updateVDVCOUSummary() {
    const vdS = get("vd_out_ouS")?.textContent ?? "";
    const vdC = get("vd_out_ouC")?.textContent ?? "";
    const vdA = get("vd_out_ouA")?.textContent ?? "";

    const vcS = get("vc_ouS")?.value ?? "";
    const vcC = get("vc_ouC")?.value ?? "";
    const vcA = get("vc_ouA")?.value ?? "";

    const vdOU = "DC " + fmtPlus(vdS) + " ; FC " + fmtPlus(vdC) + " × " + fmtAxis(vdA);
    const vcOU = fmtPlus(vcS) + " / " + fmtPlus(vcC) + " × " + fmtAxis(vcA);

    if(get("vd_ouSummary")) get("vd_ouSummary").textContent = vdOU;
    if(get("vc_ouSummary")) get("vc_ouSummary").textContent = vcOU;
  }

  // Attach listeners only to VC inputs
  ["vc_ouS","vc_ouC","vc_ouA"].forEach(id=>{
    const el = get(id);
    if(el) el.addEventListener("input", updateVDVCOUSummary);
  });

  // Call once on DOM ready
  if(document.readyState==="loading"){
    document.addEventListener("DOMContentLoaded", updateVDVCOUSummary);
  } else {
    updateVDVCOUSummary();
  }

  window._updateVDVCOUSummary = updateVDVCOUSummary;
})();
</script>

<script>
(function(){
  const get = id => document.getElementById(id);
  const safeOn = (id, evt, cb) => { const el = get(id); if(el) el.addEventListener(evt, cb); };

  function fmtPlusLocal(v){
    const n = Number(v);
    if(isNaN(n)) return "-";
    return (n>0 ? "+" : "") + n.toFixed(2);
  }
  function fmtAxisLocal(a){
    const n = Number(a);
    if(isNaN(n)) return "-";
    return Math.round(n)%180;
  }

  // --- Copy final OU spans to OD/OS VC inputs ---
  window.copyVD_OU_to_ODOS = function(){
    const sRaw = get("vd_out_ouS")?.textContent ?? "";
    const cRaw = get("vd_out_ouC")?.textContent ?? "";
    const aRaw = get("vd_out_ouA")?.textContent ?? "";

    const s = sRaw.trim()==="" ? NaN : parseFloat(sRaw);
    const c = cRaw.trim()==="" ? NaN : parseFloat(cRaw);
    const a = aRaw.trim()==="" ? NaN : parseFloat(aRaw);

    ["od","os"].forEach(eye=>{
      const vcS = get(`vc_${eye}S`);
      const vcC = get(`vc_${eye}C`);
      const vcA = get(`vc_${eye}A`);

      if(vcS) vcS.value = isNaN(s)? (vcS.value||"") : s.toFixed(2);
      if(vcC) vcC.value = isNaN(c)? (vcC.value||"") : c.toFixed(2);
      if(vcA) vcA.value = isNaN(a)? (vcA.value||"") : (Math.round(a)==a? a : a);

      [vcS,vcC,vcA].forEach(el=>{
        if(el){
          el.dispatchEvent(new Event("input",{bubbles:true}));
          el.dispatchEvent(new Event("change",{bubbles:true}));
        }
      });
    });

    try{ if(typeof window.updateFinalFromVector==="function") window.updateFinalFromVector(); }
    catch(e){ console.warn("updateFinalFromVector threw",e); }

    // Update summaries
    const vdOU = "DC "+fmtPlusLocal(sRaw)+" ; FC "+fmtPlusLocal(cRaw)+" × "+fmtAxisLocal(aRaw);
    const vcOU = fmtPlusLocal(sRaw)+" / "+fmtPlusLocal(cRaw)+" × "+fmtAxisLocal(aRaw);
    if(get("vd_ouSummary")) get("vd_ouSummary").textContent = vdOU;
    if(get("vc_ouSummary")) get("vc_ouSummary").textContent = vcOU;
  };

  safeOn("copyVD_OU_to_ODOS","click",()=>window.copyVD_OU_to_ODOS());
})();
</script>


<script>
function fireAllInputs() {
  // select all inputs that trigger updates
  const inputs = document.querySelectorAll("input");
  inputs.forEach(input => {
    input.dispatchEvent(new Event('input', { bubbles: true }));
    input.dispatchEvent(new Event('change', { bubbles: true }));
  });

  // optionally trigger any other update functions directly
  if (typeof updateCrossedLens === "function") updateCrossedLens();
  if (typeof updateFinalFromVector === "function") updateFinalFromVector();
  if (typeof updateVDVCSummary === "function") updateVDVCSummary();
  if (typeof updateVDVCOUSummary === "function") updateVDVCOUSummary();
}

// attach to all buttons with the class
document.querySelectorAll(".updateAllBtn").forEach(btn => {
  btn.addEventListener("click", fireAllInputs);
});
</script>



<script>
const content = document.getElementById("content");

document.querySelectorAll(".topMenu a").forEach(link => {
  link.addEventListener("click", () => {
    const target = document.getElementById(link.dataset.target);

    content.classList.add("fade-out");

    setTimeout(() => {
      target.scrollIntoView({ behavior: "auto" });
      content.classList.remove("fade-out");
    }, 0);
  });
});
</script>


<script>
const updateBtns = document.querySelectorAll('.updateAllBtn');
const numberInputs = document.querySelectorAll('input[type="number"]');

updateBtns.forEach(btn => btn.dataset.original = btn.innerText);

let ignoreInput = false;

document.addEventListener('input', () => {
  if (ignoreInput) return;
  updateBtns.forEach(b => {
    b.classList.remove('updated');
    b.innerText = b.dataset.original;
  });
});

updateBtns.forEach(btn => {
  btn.onclick = function () {
    ignoreInput = true;

    numberInputs.forEach(input => {
      if (input.value.trim() === '') input.value = '0.00';
    });

    ignoreInput = false;

    updateBtns.forEach(b => {
      b.classList.add('updated');
      b.innerText = 'All Updated';
    });

    // Trigger the click handler a second time immediately
    btn.click();
  };
});


</script>

<script>
let latest = { re: null, le: null };

(function(){

  function CLtoGlasses(F){ const d=0.01; return F / (1 + d * F); }
  function r025(x){ return Math.round(x/0.25)*0.25; }
  function flattenAxis(a){ a=parseFloat(a)||180; if(a<=0)a=180; return Math.round(a/10)*10; }

  function convertOne_CLtoSpec(S,C,A){
    S=parseFloat(S)||0; C=parseFloat(C)||0; A=parseFloat(A)||0;
    const total = S+C;
    const specS = CLtoGlasses(S);
    const specT = CLtoGlasses(total);
    const rawCyl = specT - specS;
    const SE = specS + rawCyl/2;

    if(Math.abs(rawCyl)<0.75) return { S: r025(SE), C:0, A:null };
    return { S: r025(specS), C: r025(rawCyl), A: flattenAxis(A) };
  }

function fmtD(x){
  return (x >= 0 ? "+" : "") + x.toFixed(2);
}

function display(side,data){
  const div = document.getElementById(side==="re"?"reResult":"leResult");
  if(!div) return;

  if(data.C === 0){
    div.textContent = `${fmtD(data.S)}`;
  } else {
    div.textContent = `${fmtD(data.S)} / ${fmtD(data.C)} x ${data.A}`;
  }

  if(side==="re") latest.re = data;
  else latest.le = data;
}

  window.convertToSpecs = function(){
    display("re", convertOne_CLtoSpec(
      document.getElementById("cl-sph-re").value,
      document.getElementById("cl-cyl-re").value,
      document.getElementById("cl-axis-re").value
    ));
    display("le", convertOne_CLtoSpec(
      document.getElementById("cl-sph-le").value,
      document.getElementById("cl-cyl-le").value,
      document.getElementById("cl-axis-le").value
    ));
  };

  window.autofillOriginalInputs = function(){
    if(latest.re){
      document.getElementById("od_origS").value = latest.re.S;
      document.getElementById("od_origC").value = latest.re.C;
      document.getElementById("od_origA").value = latest.re.A || 0;
    }
    if(latest.le){
      document.getElementById("os_origS").value = latest.le.S;
      document.getElementById("os_origC").value = latest.le.C;
      document.getElementById("os_origA").value = latest.le.A || 0;
    }
  };

})();
</script>

<script>
/* run once — add to your IIFE or below it */
document.querySelectorAll('button.greyonclick').forEach(btn=>{
  btn.addEventListener('click', function(e){
    // make grey and optionally disable
    this.classList.add('clicked');
    // uncomment to disable the button after click:
    // this.disabled = true;
  });
});
</script>

<script>
function toggleTbody(tbodyId){
  const tb = document.getElementById(tbodyId);
  if(!tb) return;

  tb.style.display = (tb.style.display === "none") ? "" : "none";
}
</script>


<script>
(function(){
  const CL_CYL_STEPS = [-0.75,-1.25,-1.75,-2.25,-2.75];

  function glassesToCL(F){ const d=0.01; return F/(1 - d*F); }
  function r025(x){ return Math.round(x/0.25)*0.25; }
  function roundUp025(x){ return Math.ceil(x/0.25)*0.25; }
  function fmt(x){ x=parseFloat(x)||0; const s=x>=0?"+":""; return s+x.toFixed(2); }
  function nearest(arr,val){ return arr.reduce((b,v)=>Math.abs(v-val)<Math.abs(b-val)?v:b,arr[0]); }
function flatterAxis(a){
  a = Math.round(parseFloat(a));
  if (!a || a < 1) return 180;
  if (a > 180) return 180;

  const base = Math.floor(a / 10) * 10;
  const upper = base + 10;
  const mid = base + 5;

  if (a === mid) {
    return a < 90 ? base : upper;
  }

  return Math.round(a / 10) * 10;
}


  function roundClipDiff(x){ return Math.round(x/0.50)*0.50; }

function convertOne(S, C, A){
  S = parseFloat(S)||0;
  C = parseFloat(C)||0;
  A = parseFloat(A)||0;

  const total = S + C;
  const convS = glassesToCL(S);
  const convT = glassesToCL(total);
  const rawCyl = convT - convS;

  if(Math.abs(rawCyl) < 0.75){
    return fmt(convS); // just sphere
  }

  const rS = r025(convS);
  const rClipC = nearest(CL_CYL_STEPS, rawCyl);
  const axis = flatterAxis(A);
  const clipDiffRounded = roundClipDiff(rawCyl - rClipC);
  const correctedSphere = roundUp025(rS + clipDiffRounded/2);

  // OUTPUT FORMAT CHANGE HERE: S / C x AXXX
  return `${fmt(correctedSphere)} / ${fmt(rClipC)} x ${axis}`;
}


const sets = [
  ["od_origCombined","os_origCombined"],
  ["od_vcCombined","os_vcCombined"],
  ["od_finalCombined","os_finalCombined"]
];

function parseText(txt){
  if(!txt) return [0,0,0];

  const m = txt.match(/([+-]?\d+(\.\d+)?)\s*\/\s*([+-]?\d+(\.\d+)?)\s*[xX×]\s*(\d+)/);
  if(!m) return [0,0,0];

  return [
    parseFloat(m[1]),
    parseFloat(m[3]),
    parseFloat(m[5])
  ];
}



  function updateCL(odSpan, osSpan, odCL, osCL){
    const [sOD,cOD,aOD] = parseText(odSpan.textContent);
    const [sOS,cOS,aOS] = parseText(osSpan.textContent);
    odCL.textContent = convertOne(sOD,cOD,aOD);
    osCL.textContent = convertOne(sOS,cOS,aOS);
  }

  sets.forEach(([odId, osId])=>{
    const odSpan = document.getElementById(odId);
    const osSpan = document.getElementById(osId);
    const odCL = document.getElementById("CL_" + odId);
    const osCL = document.getElementById("CL_" + osId);
    if(!odSpan || !osSpan || !odCL || !osCL) return;

    // Initial calculation
    updateCL(odSpan, osSpan, odCL, osCL);

    // Live update using MutationObserver
    const observer = new MutationObserver(()=>updateCL(odSpan, osSpan, odCL, osCL));
    observer.observe(odSpan, { childList: true, characterData: true, subtree: true });
    observer.observe(osSpan, { childList: true, characterData: true, subtree: true });
  });

})();
</script>


<script>
(function(){
  function mirrorSpan(sourceId, mirrorId){
    const source = document.getElementById(sourceId);
    const mirror = document.getElementById(mirrorId);
    if(!source || !mirror) return;
    mirror.textContent = source.textContent;
  }

  const mappings = [
    ['od_vectorDisplay', 'od_vectorDisplay_mirror'],
    ['OScrossedSpan', 'os_vectorDisplay_mirror'],
    ['ODcrossedSpan', 'ODcrossedSpan_mirror'],
    ['os_vectorDisplay', 'OScrossedSpan_mirror']
  ];

  function updateMirrors(){
    mappings.forEach(pair => mirrorSpan(pair[0], pair[1]));
  }

  // Example: update every time original spans change
  const observer = new MutationObserver(updateMirrors);
  mappings.forEach(pair => {
    const source = document.getElementById(pair[0]);
    if(source) observer.observe(source, { characterData:true, childList:true, subtree:true });
  });

  // Initial sync
  updateMirrors();
})();
</script>


<script>
(function(){
  'use strict';

  /* ========= GLOBAL BUTTON ADJ ========= */
  window.adj = function(type, step){
    const el = document.getElementById(type);
    if(!el) return;
    let v = parseFloat(el.value) || 0;
    v += step;
    if(type === 'axis'){
      if(v < 1) v = 180;
      if(v > 180) v = 1;
      el.value = Math.round(v);
    } else {
      el.value = v.toFixed(2);
    }
    el.dispatchEvent(new Event('input',{bubbles:true}));
  };

  /* ========= TUNABLES ========= */
  const PX_PER_D = 2;
  const K_BLUR_PER_D = 2;
  const EXTRA_ASTIG_BLUR_PER_D = 0;
  const OVERLAY_ALPHA = 0.5;
  const FC_BLUR_GAIN = 0.5;

  /* ========= ELEMENTS ========= */
  const redImg  = document.getElementById('redImg');
  const blueImg = document.getElementById('blueImg');
  const redOv   = document.getElementById('redOv');
  const blueOv  = document.getElementById('blueOv');
  const fanImg  = document.getElementById('fanChart');
  const outer   = document.getElementById('outerCircle');

  const sphInput  = document.getElementById('sph');
  const cylInput  = document.getElementById('cyl');
  const axisInput = document.getElementById('axis');

  /* ========= STATE ========= */
  let TRUE = { sph:0, cyl:0, axis:180, se:0 };

  /* ========= HELPERS ========= */
  const quant05 = v => Math.round(v*2)/2;

  function wrapAxis(v){
    let n = parseFloat(v);
    if(!Number.isFinite(n)) return 180;
    n = ((Math.round(n)%180)+180)%180;
    return n===0 ? 180 : n;
  }

  /* ========= CORE ========= */
  function recompute(){
    TRUE.sph  = parseFloat(sphInput.value) || 0;
    TRUE.cyl  = parseFloat(cylInput.value) || 0;
    TRUE.axis = wrapAxis(axisInput.value);
    TRUE.se   = TRUE.sph + TRUE.cyl/2;   // DELTA SE
    render();
  }

  function render(){
    const deltaSE = TRUE.se;
    const cyl  = TRUE.cyl;
    const axis = TRUE.axis;

    /* ---- SPH → DOMINANT SIDE BLUR ---- */
    const s = Math.abs(deltaSE);
    const primary   = s * K_BLUR_PER_D;
    const secondary = (s >= 0.75) ? ((s - 0.5) * K_BLUR_PER_D) : 0;

    let blurRed = 0, blurBlue = 0;
    if(deltaSE > 0){
      blurRed  = primary;
      blurBlue = secondary;
    } else if(deltaSE < 0){
      blurBlue = primary;
      blurRed  = secondary;
    }

    redImg.style.filter  = `blur(${quant05(blurRed)}px)`;
    blueImg.style.filter = `blur(${quant05(blurBlue)}px)`;

    /* ---- CYL → DUOCHROME SEPARATION ---- */
    const mag = Math.abs(cyl) * PX_PER_D;
    const rad = (((axis % 180) * 2) - 90) * Math.PI / 180;
    const dx = Math.round(Math.cos(rad) * mag);
    const dy = Math.round(Math.sin(rad) * mag);

    redOv.style.transform  = `translate(${dx}px, ${dy}px)`;
    blueOv.style.transform = `translate(${dx}px, ${dy}px)`;

    if(Math.abs(cyl) > 0.01){
      redImg.style.transform  = `translate(${-dx}px, ${-dy}px)`;
      blueImg.style.transform = `translate(${-dx}px, ${-dy}px)`;
    } else {
      redImg.style.transform  = 'translate(0,0)';
      blueImg.style.transform = 'translate(0,0)';
    }

    /* ---- ASTIG BLUR ---- */
    const extra = Math.abs(cyl) * EXTRA_ASTIG_BLUR_PER_D;
    redOv.style.filter  = `blur(${quant05(blurRed  + extra)}px)`;
    blueOv.style.filter = `blur(${quant05(blurBlue + extra)}px)`;
    redOv.style.opacity = blueOv.style.opacity = OVERLAY_ALPHA;

    /* ---- FAN CHART ---- */
const absC = Math.abs(cyl);
let img;
if(absC === 0)             img = "C000.png";
else if(absC <= 0.25)      img = "C050.png";
else if(absC <= 0.5)       img = "C075.png";
else if(absC <= 0.75)      img = "C100.png";
else                       img = "C150.png";
fanImg.src = `https://raw.githubusercontent.com/kiaraoptometrypx/Trainer/main/${img}`;



    const axisFC  = (axis) % 180;
    const fcShift = (deltaSE > 0) ? 90 : 0;
    outer.style.transform = `scaleX(-1) rotate(${-(axisFC + fcShift)}deg)`;
  }

  /* ========= EVENTS ========= */
  sphInput.addEventListener('input', recompute);
  cylInput.addEventListener('input', recompute);
  axisInput.addEventListener('input', ()=>{
    axisInput.value = wrapAxis(axisInput.value);
    recompute();
  });
  axisInput.addEventListener('keydown', e=>{
    if(e.key==='ArrowUp'){ e.preventDefault(); axisInput.value=wrapAxis(+axisInput.value+1); recompute(); }
    if(e.key==='ArrowDown'){ e.preventDefault(); axisInput.value=wrapAxis(+axisInput.value-1); recompute(); }
  });

  /* ========= INIT ========= */
  recompute();

})();
</script>




<script>
/* =================== Helpers =================== */
function round025(x){ return Math.round(x*4)/4; }
function formatDiopter(x){
  return (x>=0?"+":"") + Number(x).toFixed(2);
}
function formatSphChange(x){
  return `${formatDiopter(x)}`;
}
function formatCylChange(x){
  return `${formatDiopter(x)}`;
}

/* =================== Axis Dropdown =================== */
const axisLocked = [
  {label:"3-9 , 9-3", deg:180},{label:"3:30-9:30 , 9:30-3:30", deg:15},
  {label:"4-10 , 10-4", deg:30},{label:"4:30-10:30 , 10:30-4:30", deg:45},
  {label:"5-11 , 11-5", deg:60},{label:"5:30-11:30 , 11:30-5:30", deg:75},
  {label:"6-12 , 12-6", deg:90},{label:"6:30-12:30 , 12:30-6:30", deg:105},
  {label:"7-1 , 1-7", deg:120},{label:"7:30-1:30 , 1:30-7:30", deg:135},
  {label:"8-2 , 2-8", deg:150},{label:"8:30-2:30 , 2:30-8:30", deg:165}
];

function populateAxisDarker(){
  const sel = document.getElementById("axisDarker");
  const fan = document.getElementById("fanchart").value;

  sel.innerHTML = '<option value="">--Select--</option>';

  // Only populate options if fan chart is "one_clearer"
  if(fan === "one_clearer"){
    axisLocked.forEach(a=>{
      const opt=document.createElement("option");
      opt.value=a.deg;
      opt.textContent=a.label;
      sel.appendChild(opt);
    });
    sel.disabled = false;
  } else {
    // Otherwise disable the dropdown
    sel.disabled = true;
  }
}

// Run on page load
populateAxisDarker();

// Add reactive listener to fan chart change
document.getElementById("fanchart").addEventListener("change", populateAxisDarker);


/* =================== Cylinder / Vector Math =================== */
function toMinusCyl(cyl, axis){
  cyl=Number(cyl)||0; axis=Number(axis)||0;
  if(cyl>0){
    let n=-cyl;
    let a=(axis+90)%180; if(a===0)a=180;
    return {cyl:n, axis:a};
  }
  return {cyl, axis};
}
function cylAxisToJ0J45(cyl, axis){
  const rad=axis*Math.PI/180;
  return {
    j0:(-cyl/2)*Math.cos(2*rad),
    j45:(-cyl/2)*Math.sin(2*rad)
  };
}
function j0j45ToCylAxisVals(j0,j45){
  const mag=Math.sqrt(j0*j0+j45*j45);
  let cyl=-2*mag;
  let axis=cyl===0?0:0.5*Math.atan2(j45,j0)*180/Math.PI;
  if(axis<0) axis+=180;
  if(cyl>0){
    cyl=-cyl;
    axis=(axis+90)%180; if(axis===0)axis=180;
  }
  return { cyl:Number(cyl.toFixed(2)), axis:Math.round(axis) };
}

/* =================== Cross Cylinder =================== */
function crossCylinder(orig, deltaC, deltaAxis){
  const minus=toMinusCyl(orig.cyl, orig.axis);
  const jO=cylAxisToJ0J45(minus.cyl, minus.axis);
  const jD=cylAxisToJ0J45(deltaC, deltaAxis);
  const vals=j0j45ToCylAxisVals(jO.j0+jD.j0, jO.j45+jD.j45);

  const SE=Number(orig.sph||0)+(Number(orig.cyl||0))/2+deltaC/2;
  const sph=Number((SE - vals.cyl/2).toFixed(2));
  return { sph, cyl:vals.cyl, axis:vals.axis };
}

/* =================== Rule Engine =================== */
function runFanChartCalculation(input){
  const out=[];
  const sph0=Number(input.sph)||0;
  const cyl0=Number(input.cyl)||0;
  const axis0=Number(input.axis)||0;
  const du=input.duochrome;
  const fan=input.fanChart;
  const dark=input.axisDarkerDeg?Number(input.axisDarkerDeg):null;

  // If fan chart not selected or axis missing, show note only
  if(!fan){
    out.push({usedPower:"Please select Fan Chart"});
    return out;
  }

  if(fan==="one_clearer" && dark===null){
    out.push({usedPower:"Please select Darker Axis"});
    return out;
  }

  // Both clear case
  if(du==="both_clear"){
    out.push({usedPower:"No changes needed. Rx is optimized."});
    return out;
  }

  // Both slightly + multiple_clear_blur
  if(du==="both_slightly" && fan==="multiple_clear_blur"){
    out.push({usedPower:"No changes needed. Rx is optimized but vision may blur due to other causes."});
    return out;
  }


// ✅ NEW FIXED CASE: Both moderately + multiple_clear_blur
if(du==="both_moderately" && fan==="multiple_clear_blur"){
  out.push({usedPower:"Conclusion: Poor visual acuity with astigmatism from dry eyes or corneal irregularity."});
  return out;
}

// ✅ NEW FIXED CASE: Both moderately + all_similar
if(du==="both_moderately" && fan==="all_blur"){
  out.push({usedPower:"Conclusion: Poor visual acuity with astigmatism from dry eyes or corneal irregularity."});
  return out;
}

  // ====== Normal calculations ======
  const dash=()=>out.push({usedPower:"Choose all selection"});

  if(fan!=="one_clearer"){
    if(du==="red")   [-0.25,-0.50].forEach(d=>out.push({
      sph:sph0+d,cyl:toMinusCyl(cyl0,axis0).cyl,axis:toMinusCyl(cyl0,axis0).axis,
      usedPower:formatSphChange(d)
    }));
    else if(du==="blue") [0.25,0.50].forEach(d=>out.push({
      sph:sph0+d,cyl:toMinusCyl(cyl0,axis0).cyl,axis:toMinusCyl(cyl0,axis0).axis,
      usedPower:formatSphChange(d)
    }));
    else if(du==="both_badly") [2,-2].forEach(d=>out.push({
      sph:sph0+d,cyl:toMinusCyl(cyl0,axis0).cyl,axis:toMinusCyl(cyl0,axis0).axis,
      usedPower:formatSphChange(d)
    }));
    else dash();
    return out;
  }

  if(dark===null){ dash(); return out; }
  const perp=(dark+90)%180;

  if(du==="red") [-0.25,-0.50].forEach(d=>out.push({
    ...crossCylinder({sph:sph0,cyl:cyl0,axis:axis0},d,perp),
    usedPower:`PL / ${formatCylChange(d)} × ${perp}`
  }));
  else if(du==="blue") [0.25,0.50].forEach(d=>out.push({
    ...crossCylinder({sph:sph0,cyl:cyl0,axis:axis0},d,perp),
    usedPower:`PL / ${formatCylChange(d)} × ${perp}`
  }));
  else if(du==="both_clear") out.push({
    ...crossCylinder({sph:sph0,cyl:cyl0,axis:axis0},0.25,perp),
    usedPower:`PL / ${formatCylChange(0.25)} × ${perp}`
  });
  else if(du==="both_moderately") [[0.25,-0.50],[0.50,-1.00]].forEach(p=>out.push({
    ...crossCylinder({sph:sph0+p[0],cyl:cyl0,axis:axis0},p[1],dark),
    usedPower:`${formatSphChange(p[0])} / ${formatCylChange(p[1])} × ${dark}`
  }));
  else if(du==="both_badly") [1.50,-1.50].forEach(d=>out.push({
    ...crossCylinder({sph:sph0,cyl:cyl0,axis:axis0},d,perp),
    usedPower:`PL / ${formatCylChange(d)} × ${perp}`
  }));
  else dash();

  return out;
}


/* =================== Run & Display =================== */
let lastResults=[];
function runAllCalculations(){
  const input={
    sph:TS_sph.value,cyl:TS_cyl.value,axis:TS_axis.value,
    duochrome:duochrome.value,
    fanChart:fanchart.value,
    axisDarkerDeg:axisDarker.value
  };
  const res=runFanChartCalculation(input);
  lastResults=res;

result.innerHTML = "";
res.forEach((r, i) => {
  const row = document.createElement("div");
  row.className = "resultRow";
  row.textContent =
    `Option ${i + 1}: Change ${r.usedPower}, New RX ` +
    `${formatDiopter(round025(r.sph))} / ` +
    `${formatDiopter(round025(r.cyl))} X ${r.axis}`;

  const btn = document.createElement("button");
  btn.textContent = "Refine this RX";
  btn.style.marginLeft = "3%";
  btn.onclick = () => {
    TS_sph.value = r.sph !== "-" ? r.sph : "";
    TS_cyl.value = r.cyl !== "-" ? r.cyl : "";
    TS_axis.value = r.axis !== "-" ? r.axis : "";
  };

  row.appendChild(btn);
  result.appendChild(row);
});

}

/* =================== Reset =================== */
resetBtn.onclick=()=>{
  TS_sph.value=0; TS_cyl.value=0; TS_axis.value=0;
};

/* =================== Lock Final =================== */
lockFinalBtn.onclick=()=>{
  const sph=Number(TS_sph.value)||0;
  const cyl=Number(TS_cyl.value)||0;
  const axis=TS_axis.value||0;

  const tr=document.createElement("tr");
  tr.innerHTML=`
    <td class="red" style="width:50%">
      ${formatDiopter(round025(sph))} /
      ${formatDiopter(round025(cyl))} X ${axis}
      <button class="removeBtn" onclick="this.closest('tr').remove()">Remove</button>
    </td>
    <td class="red" style="width:40%">
      <input style="width:80%" type="text" placeholder="Comment">
    </td>`;
  document.querySelector("#finalTable tbody").appendChild(tr);
};

const lookup = {
  "red|all_blur": "1. Myope, almost no astig.",
  "red|one_clearer": "2. Myope, has astig possibly more than 0.50.",
  "red|multiple_clear_blur": "3. Myope, has irregular astig from dry eyes, corneal irregularity or internal (cataract, macula, vitreous etc).",
  "blue|all_blur": "4. Hyperope, almost no astig.",
  "blue|one_clearer": "5. Hyperope, has astig possibly more than 0.50 CYL.",
  "blue|multiple_clear_blur": "6. Hyperope, astig from dry eyes, corneal irregularity or internal (cataract, macula, vitreous etc).",
  "both_badly|all_blur": "7. High myope or high hyperope. Use -2.00 if patient can see near. Use +2.00 if patient cannot see near.",
  "both_badly|one_clearer": "8. High myope or high hyperope. Try both option and ask which is better.",
  "both_badly|multiple_clear_blur": "9. High myope or high hyperope, irregular astig from dry eyes, corneal irregularity or internal (cataract, macula, vitreous etc).",
  "both_slightly|all_blur": "10. Poor visual acuity. Possibly from internal (cataract, macula, vitreous etc) or amblyopia.",
  "both_slightly|one_clearer": "11. Astig mostly disturbing the vision.",
  "both_slightly|multiple_clear_blur": "12. Poor visual acuity with irregular astig from dry eyes, corneal irregularity or internal (cataract, macula, vitreous etc).",
  "both_clear|one_clearer": "13. Sharp visual acuity with astigmatism.",
  "both_clear|multiple_clear_blur": "14. Sharp visual acuity with irregular astig from dry eyes, corneal irregularity or internal (cataract, macula, vitreous etc)."
};

function runAllCalculations(){
  const input={
    sph:TS_sph.value, cyl:TS_cyl.value, axis:TS_axis.value,
    duochrome:duochrome.value,
    fanChart:fanchart.value,
    axisDarkerDeg:axisDarker.value
  };
  const res=runFanChartCalculation(input);
  lastResults=res;

  const key = `${input.duochrome}|${input.fanChart}`;
  const description = lookup[key] || "";

  result.innerHTML = "";
// Add the lookup description above all results in one line
if(description){
  const descSpan = document.createElement("span");
  descSpan.style.fontWeight = "bold";
  descSpan.style.marginBottom = "2%"; // spacing below description
  descSpan.style.display = "inline-block"; // so margin applies
  descSpan.textContent = `Scenario: ${description} Start with Option 2 and if reversal happens, choose Option 1.`;
  result.insertBefore(descSpan, result.firstChild); // only once
}

  // Display each RX option as before
res.forEach((r, i) => {
  const row = document.createElement("div");
  row.className = "resultRow";

  // Only show note if sph/cyl/axis are missing
  if(r.sph===undefined && r.cyl===undefined && r.axis===undefined){
    row.textContent = r.usedPower || "Choose all selection";
  } else {
    row.textContent =
      `Option ${i + 1}: Change ${r.usedPower}, New RX ` +
      `${formatDiopter(round025(r.sph))} / ` +
      `${formatDiopter(round025(r.cyl))} X ${r.axis}`;

    const btn = document.createElement("button");
    btn.textContent = "Refine this RX";
    btn.style.marginLeft = "3%";
    btn.onclick = () => {
      TS_sph.value = r.sph !== "-" ? r.sph : "";
      TS_cyl.value = r.cyl !== "-" ? r.cyl : "";
      TS_axis.value = r.axis !== "-" ? r.axis : "";
    };
    row.appendChild(btn);
  }

  result.appendChild(row);
});
}



</script>

<script>
function adjustValue(id, delta){
  const el = document.getElementById(id);
  el.value = (parseFloat(el.value) || 0) + delta;
  el.dispatchEvent(new Event('input'));
}

function adjustValue(id, delta){
  const el = document.getElementById(id);
  const current = parseFloat(el.value) || 0;

  // snap to 0.25 D steps
  const snapped = Math.round((current + delta) * 4) / 4;

  el.value = snapped.toFixed(2); // keeps clean diopter format
  el.dispatchEvent(new Event('input'));
}
</script>



<script>
const slider = document.querySelector(".fade-compare input");
const relax = document.getElementById("imgRelax");
const work = document.getElementById("imgWork");

slider.addEventListener("input", () => {
  const v = slider.value / 100;
  relax.style.opacity = 1 - v;
  work.style.opacity = v;
});
</script>







</body>
</html>
